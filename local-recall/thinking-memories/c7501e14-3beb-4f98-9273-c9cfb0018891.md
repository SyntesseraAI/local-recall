---
id: c7501e14-3beb-4f98-9273-c9cfb0018891
subject: >-
  Now I understand the full picture. The issue is: 1. The
  `user-prompt-submit.ts` hook guards against...
applies_to: global
occurred_at: '2025-11-30T14:57:19.165Z'
content_hash: 1f8ad516f52d780e
---
Now I understand the full picture. The issue is:

1. The `user-prompt-submit.ts` hook guards against internal prompts by checking for the `[LOCAL_RECALL_INTERNAL]` prefix at line 161
2. The `buildMemoryExtractionPrompt` in `src/prompts/memory-extraction.ts` does NOT include this prefix
3. When the MCP server's daemon calls `claude -p` with the memory extraction prompt, it goes through Claude Code's normal prompt flow, which triggers the `UserPromptSubmit` hook again
4. Since the memory extraction prompt doesn't have the `[LOCAL_RECALL_INTERNAL]` prefix, the hook doesn't skip it, causing recursion issues

The fix should be to add the `[LOCAL_RECALL_INTERNAL]` prefix to the memory extraction prompt in `buildMemoryExtractionPrompt`.

Let me fix this:
