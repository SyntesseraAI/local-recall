---
id: 57d94a38-adff-4788-9304-e61ace0a0b74
subject: sqlite-vec loading sequence and file locking mechanism
keywords:
  - sqlite-vec
  - native extension
  - file locking
  - database initialization
  - mutex
applies_to: 'file:src/utils/database.ts'
occurred_at: '2025-12-03T10:22:44.117Z'
content_hash: fe7db80f4efb4515
---
The sqlite-vec extension is loaded in database.ts around line 152 via `sqliteVec.load(db)`. A file locking mechanism exists in the initializeDatabase function to prevent concurrent loading. The lock file is stored at `{memoryDir}/.db.lock`. Lock acquisition includes retry logic with timing and PID logging. However, the mutex error still occurs when multiple processes attempt to load sqlite-vec, suggesting the file lock alone is insufficient for concurrent hook processes.
