---
id: 605adffb-5395-4ccf-81fb-463c81d7fbeb
subject: Token-based limiting for thinking memory retrieval with configurable budget
keywords:
  - token limiting
  - retrieval budget
  - thinking memories
  - configuration
  - similarity threshold
applies_to: 'file:src/hooks/user-prompt-submit-thinking.ts'
occurred_at: '2025-12-21T19:14:30.494Z'
content_hash: f626940250eb5acf
---
Thinking memory retrieval was changed from count-based (fixed number of memories) to token-based limiting. This provides better control over context injection.

New configuration options:
- `LOCAL_RECALL_THINKING_MAX_TOKENS` (default: 1000) - Maximum tokens to inject
- `LOCAL_RECALL_THINKING_MIN_SIMILARITY` (default: 0.8) - Minimum similarity threshold (0.0-1.0, default is 80%)

Algorithm:
1. Search vector store with query embedding
2. Filter results by minimum similarity threshold
3. Add memories in order until token budget is exceeded
4. Inject formatted memories into context

Configuration is managed in `src/utils/config.ts` and schema defined in `src/core/types.ts`.
