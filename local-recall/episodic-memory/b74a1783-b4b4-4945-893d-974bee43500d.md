---
id: b74a1783-b4b4-4945-893d-974bee43500d
subject: >-
  Mutex lock failed error caused by concurrent sqlite-vec loading across
  processes
keywords:
  - sqlite-vec
  - mutex
  - concurrency
  - threading
  - error
  - pthread
  - EINVAL
applies_to: global
occurred_at: '2025-12-21T18:28:54.683Z'
content_hash: 0d7b09e4c8b59ba1
---
The 'mutex lock failed: Invalid argument' error occurs when multiple processes try to load sqlite-vec simultaneously. The error is a C++ pthread_mutex_lock() returning EINVAL, which happens when a thread attempts to lock a mutex that was destroyed or is in an invalid state.

**Root Cause**: When the MCP server daemon and hooks run concurrently, both try to load the sqlite-vec module. The native binding gets partially initialized by one process, then the second process tries to use a destroyed mutex.

**Solution Applied**: Migrate from sqlite-vec (C++ bindings) to Orama (pure JavaScript). This eliminates the mutex issue entirely since Orama has no native dependencies.

**Migration Details**:
- Replaced `src/core/vector-store.ts` implementation to use Orama instead of sqlite-vec
- Updated embedding generation to work with Orama's JSON format
- Changed index persistence from SQLite database to JSON file (`orama-*-index.json`)
- Simplified thread safety - no more native mutex concerns

**Status**: Migration complete and tested. Orama is now the primary vector storage backend.
