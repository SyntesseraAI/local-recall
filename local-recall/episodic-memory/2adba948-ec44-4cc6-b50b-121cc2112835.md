---
id: 2adba948-ec44-4cc6-b50b-121cc2112835
subject: Token-based retrieval for thinking memories instead of count-based limiting
keywords:
  - token limiting
  - thinking retrieval
  - context budget
  - configuration
  - user-prompt-submit-thinking
applies_to: 'file:src/hooks/user-prompt-submit-thinking.ts'
occurred_at: '2025-12-21T18:17:09.782Z'
content_hash: d2bc3148c3fd2000
---
Changed thinking memory retrieval from returning a fixed count of memories to accumulating memories until a token budget is reached. This provides more flexible control over context injection.

**Configuration:**
- `LOCAL_RECALL_THINKING_MAX_TOKENS` (default: 1000) - Maximum tokens to inject per prompt
- `LOCAL_RECALL_THINKING_MIN_SIMILARITY` (default: 0.8) - Minimum similarity threshold (80%) for thinking memory retrieval

**Implementation:**
- Memories are added in similarity score order (highest first)
- Stops adding when the next memory would exceed the token budget
- Configurable via environment variables and config file

This approach allows users to control how much thinking context is injected based on their token budget constraints.
