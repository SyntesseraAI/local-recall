---
id: 55523805-358f-4543-b8aa-9ca1d632d3e8
subject: Database locking mechanism prevents concurrent sqlite-vec loading errors
keywords:
  - database
  - sqlite-vec
  - mutex
  - file locking
  - concurrent access
  - socket opening
applies_to: 'file:src/utils/database.ts'
occurred_at: '2025-12-21T19:15:00.052Z'
content_hash: 642dddbb01a054a7
---
The sqlite-vec C++ extension throws 'socket already open' errors when loaded concurrently from multiple processes. This happens when hooks run in parallel during the UserPromptSubmit phase.

Implemented file-based locking in `src/utils/database.ts`:
- `acquireDatabaseLock()`: Creates a lock file before loading sqlite-vec
- `releaseDatabaseLock()`: Removes the lock file after loading
- Timeout of 5 seconds per lock attempt
- Automatic stale lock detection (older than 3 seconds)
- Graceful fallback when lock acquisition fails

This prevents concurrent socket initialization while maintaining error resilience.
