---
id: 85890e6c-2291-4cf2-a105-7a0edfbf2487
subject: Fix AbortError in user-prompt-submit hook's Claude CLI subprocess handling
keywords:
  - abort error
  - spawn timeout
  - child process
  - promise rejection
  - user-prompt-submit hook
  - saferesolve
  - race condition
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-01T15:58:30.716Z'
content_hash: e1d0b14dc7cc7601
---
The user-prompt-submit hook was throwing an unhandled AbortError when calling Claude CLI for keyword extraction via `callClaudeForKeywords()` function.

## Root Cause
1. The `spawn()` function had a timeout set via `AbortSignal`
2. When timeout expired, it rejected the promise
3. No proper error handling was wrapping the promise rejection
4. This caused an unhandled promise rejection that crashed the hook

## Solution
Implemented SafeResolve wrapper pattern:
- Wrapped the `spawn()` call in `safeResolve()` helper function
- This catches promise rejections and returns them as error objects
- Prevents unhandled rejections from crashing the process
- Allows graceful degradation when Claude CLI times out

## Implementation Details
- Used try-catch around `await safeResolve()` to handle errors
- Returns empty array `[]` for keywords when extraction fails
- Prevents hook from crashing due to subprocess timeout or failure
- Allows memory search to proceed with default behavior when keyword extraction unavailable
