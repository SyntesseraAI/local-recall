---
id: b01c8b56-13f9-4a78-bd58-6a0cbc1afb2a
subject: Concurrent database access race condition between episodic and thinking hooks
keywords:
  - mutex
  - sqlite
  - race condition
  - concurrent access
  - hook
  - user-prompt-submit
applies_to: global
occurred_at: '2025-12-03T09:49:02.141Z'
content_hash: b04c2c3f14d22115
---
Both `user-prompt-submit.js` (episodic) and `user-prompt-submit-thinking.js` (thinking) hooks fire simultaneously when a user submits a prompt. Both attempt to open and lock the same `memory.sqlite` database file via different vector store instances (VectorStore and ThinkingVectorStore). This creates a race condition where the sqlite-vec native C++ mutex fails with 'mutex lock failed: Invalid argument'. The solution is to run thinking memory extraction in the daemon instead of the hook, avoiding concurrent database access.
