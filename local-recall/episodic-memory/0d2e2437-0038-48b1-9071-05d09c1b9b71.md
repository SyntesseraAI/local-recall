---
id: 0d2e2437-0038-48b1-9071-05d09c1b9b71
subject: Fix AbortError in user-prompt-submit hook from spawn timeout handling
keywords:
  - user-prompt-submit
  - spawn
  - timeout
  - AbortError
  - async
  - error-handling
  - child-process
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-02T06:24:56.200Z'
content_hash: 1ff6168de24be0db
---
## Issue
The `callClaudeForKeywords` function in user-prompt-submit.ts was throwing unhandled AbortError when Node.js's spawn timeout killed the child process. This occurred because:

1. The `spawn` call had a `timeout` option (line 41) that internally aborts the process
2. Node.js throws `AbortError` when a child process is aborted, but this wasn't being caught
3. The promise rejection wasn't being handled, causing an unhandled promise rejection

## Root Cause
The built-in Node.js spawn timeout throws an AbortError that differs from normal error handling - it kills the process internally without proper error propagation to the promise handlers.

## Solution Applied
1. **Removed the `timeout` option** from the spawn call to prevent automatic process abortion
2. **Added `safeResolve` wrapper** to ensure the promise only resolves once, preventing race conditions
3. **Removed duplicate `close` handlers** - there were two `child.on('close', ...)` listeners which could cause issues
4. **Added early-exit guard** in the close handler to prevent multiple resolutions

This ensures all child process events (timeout, completion, errors) are properly handled without unhandled promise rejections.
