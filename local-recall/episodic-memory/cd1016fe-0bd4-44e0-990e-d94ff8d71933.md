---
id: cd1016fe-0bd4-44e0-990e-d94ff8d71933
subject: Hook process isolation and concurrent access patterns in local-recall
keywords:
  - concurrency
  - mutex
  - hooks
  - process isolation
  - file locking
applies_to: global
occurred_at: '2025-12-21T19:16:20.911Z'
content_hash: f0200aaa79f9a9de
---
## Architecture Constraint
Hooks run as separate processes triggered by Claude Code events. When multiple hooks execute concurrently (e.g., SessionStart + UserPromptSubmit), they can have mutual exclusion issues with shared resources.

## Current Issues
1. **sqlite-vec is not thread/process safe**: Native C++ module with internal mutex that fails under concurrent access
2. **File locking alone insufficient**: Even with file-based locking in place, C++ native modules can crash

## Best Practice
Hooks should be lightweight and stateless:
- Use HTTP daemon for all database operations
- Avoid loading native C++ modules (sqlite-vec, etc.) in hooks
- Keep hooks as thin wrappers that communicate with a central daemon
- Let the daemon handle all database concurrency internally
