---
id: a6a2c55a-8336-44be-8049-6e23761153d4
subject: >-
  User-prompt-submit hook directly loads embedding models, causing mutex
  conflicts
keywords:
  - user-prompt-submit
  - hook
  - embedding
  - search-engine
  - concurrency
  - race-condition
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T18:26:49.611Z'
content_hash: e5a9a58450d4cb81
---
The user-prompt-submit hook directly instantiates SearchEngine and ThinkingSearchEngine, which load the ONNX embedding model via fastembed. This creates a race condition when multiple Claude instances run concurrently - each hook process tries to load ONNX simultaneously, triggering mutex errors.

Concurrent execution test results: 15 mutex errors from 15 parallel hook processes, confirming the issue is systematic and reproducible.
