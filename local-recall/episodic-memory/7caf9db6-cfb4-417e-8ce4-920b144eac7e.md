---
id: 7caf9db6-cfb4-417e-8ce4-920b144eac7e
subject: >-
  Mutex error in UserPromptSubmit hook caused by sqlite-vec loading in
  multi-process environment
keywords:
  - mutex error
  - sqlite-vec
  - hook
  - file locking
  - concurrency
  - user-prompt-submit
applies_to: global
occurred_at: '2025-12-21T19:16:09.210Z'
content_hash: 1604d360b8cd44bc
---
The UserPromptSubmit hook was throwing 'mutex lock failed: Invalid argument' because it directly instantiated SearchEngine and ThinkingSearchEngine, which load sqlite-vec. This causes mutex issues when multiple processes try to load the same native module.

**Root Cause**: sqlite-vec uses native file locking mechanisms that fail when accessed from multiple concurrent processes (hooks run in separate processes).

**Solution**: Add comprehensive logging with PID tracking to identify which processes are failing and when. Log:
- Process ID (PID) for all operations
- Lock acquisition attempts and elapsed time
- sqlite-vec loading timing separately
- Full stack traces on errors

This helps differentiate between file locking issues and actual mutex problems. The file locking mechanism exists in database.ts but didn't provide enough visibility into the failure point.
