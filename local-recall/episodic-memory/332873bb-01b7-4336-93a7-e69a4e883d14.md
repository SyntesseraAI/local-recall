---
id: 332873bb-01b7-4336-93a7-e69a4e883d14
subject: >-
  UserPromptSubmit hook mutex error caused by direct sqlite-vec loading in hook
  process
keywords:
  - mutex error
  - sqlite-vec
  - hook
  - libc++abi
  - file locking
  - concurrent access
applies_to: global
occurred_at: '2025-12-21T19:16:20.911Z'
content_hash: 1d912d52a836120d
---
## Problem
The UserPromptSubmit hook was failing with: `libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument`

## Root Cause
The hook was directly instantiating `SearchEngine` and `ThinkingSearchEngine` which load sqlite-vec (a C++ native module). When multiple hooks run concurrently, sqlite-vec's internal mutex fails because it's not designed for concurrent access from different processes.

## Solution
The proper approach is to use HTTP daemon communication instead of direct database loading in hooks. Hooks should:
1. Contact the MCP daemon via HTTP
2. Let the daemon handle all database access
3. Not load sqlite-vec or other native modules directly

## Files Affected
- src/hooks/user-prompt-submit.ts (needs refactor to use HTTP daemon)
- src/utils/database.ts (file locking exists but insufficient for concurrent C++ module access)
- src/core/vector-store.ts (uses sqlite-vec)

## Logging Improvements Made
Added comprehensive logging to help diagnose similar issues:
- PID logging `[PID:xxxx]` on all log entries to track which process is running
- Lock acquisition timing and attempt counts
- sqlite-vec load timing with separate measurements
- Full stack traces on failures
