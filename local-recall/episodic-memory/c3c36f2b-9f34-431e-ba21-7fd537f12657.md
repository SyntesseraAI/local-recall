---
id: c3c36f2b-9f34-431e-ba21-7fd537f12657
subject: >-
  SQLite concurrency issue: mutex lock failed when hooks and daemon access
  memory.sqlite simultaneously
keywords:
  - sqlite
  - concurrency
  - database
  - hooks
  - daemon
  - readonly
  - wal-mode
  - busy-timeout
applies_to: global
occurred_at: '2025-12-21T19:46:45.954Z'
content_hash: cfa6a53a284fd5b3
---
## Problem
Both the MCP server daemon and hooks tried to access the same `memory.sqlite` file simultaneously, causing SQLite mutex lock errors: `libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument`

## Root Cause
The `sqlite-vec` extension has issues with concurrent access when multiple database connections open the same file without proper locking and timeout configuration.

## Solution Implemented
Created `src/utils/database.ts` with proper SQLite configuration:
1. **Busy Timeout (30s)** - SQLite waits for locks instead of failing immediately
2. **WAL Mode** - Enables concurrent readers and writers by using a write-ahead log
3. **Read-Only Mode** - Hooks (which only perform search operations) open the database in read-only mode, completely avoiding write locks
4. **Retry Logic** - Exponential backoff for transient failures

## Files Modified
- `src/utils/database.ts` (new) - Shared database utility with `openDatabase()` function
- `src/core/vector-store.ts` - Updated to use `openDatabase()` with write mode for the daemon
- `src/core/thinking-vector-store.ts` - Same changes as vector-store
- `src/core/search.ts` - Updated to pass `readonly: true` for hook searches
- `src/core/thinking-search.ts` - Updated to pass `readonly: true` for hook searches
- `src/hooks/user-prompt-submit.ts` - Uses readonly mode
- `src/hooks/user-prompt-submit-thinking.ts` - Uses readonly mode

## Why This Works
Read-only connections in SQLite don't acquire write locks, so multiple hooks can search simultaneously without contention. The daemon (which writes) acquires locks naturally with WAL mode allowing concurrent readers.
