---
id: b8e66af4-7728-49f8-bb26-1e674b7ec85d
subject: Implemented proper-lockfile for serializing fastembed access
keywords:
  - proper-lockfile
  - file-based lock
  - embedding.ts
  - mutex
  - synchronization
applies_to: 'file:src/core/embedding.ts'
occurred_at: '2025-12-21T19:21:45.415Z'
content_hash: 9e1f27214a11db51
---
Added file-based locking using `proper-lockfile` to prevent concurrent access to fastembed/onnxruntime-node:

- Lock file location: `/tmp/local-recall-embedding.lock`
- Retries: 10 with exponential backoff (100ms - 2s)
- Stale lock timeout: 30 seconds
- Locked operations: Both `initialize()` and `embed()` methods

This serializes concurrent hook processes so only one at a time loads or uses the native onnxruntime module, preventing mutex errors.
