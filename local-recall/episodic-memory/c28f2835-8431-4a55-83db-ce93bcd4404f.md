---
id: c28f2835-8431-4a55-83db-ce93bcd4404f
subject: 'Database concurrency issue: hooks and daemon competing for SQLite access'
keywords:
  - concurrency
  - sqlite
  - database
  - mutex
  - hooks
  - daemon
  - lock
applies_to: global
occurred_at: '2025-12-03T09:48:06.256Z'
content_hash: 29e42bc3fec08e67
---
The MCP server daemon and Claude Code hooks (UserPromptSubmit, Stop) were simultaneously accessing the same `memory.sqlite` file, causing mutex lock failures. The `sqlite-vec` extension had issues with concurrent write access.

**Root cause**: Both daemon and hooks opened separate database connections without proper concurrency controls.

**Solution implemented**:
- Created `src/utils/database.ts` with centralized SQLite management
- Added 30-second busy timeout to allow SQLite to wait for locks instead of failing immediately
- Enabled WAL (Write-Ahead Logging) mode for concurrent readers and writers
- Hooks now open database in **read-only mode** to completely avoid write locks
- Added retry logic with exponential backoff (up to 3 retries)

**Key insight**: Read-only mode eliminates concurrency issues for search-only operations (hooks) while allowing writes from daemon.
