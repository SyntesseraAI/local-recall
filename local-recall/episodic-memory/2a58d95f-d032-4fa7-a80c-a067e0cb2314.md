---
id: 2a58d95f-d032-4fa7-a80c-a067e0cb2314
subject: >-
  Session guarding bug: Memory extraction prompt must include
  [LOCAL_RECALL_INTERNAL] prefix
keywords:
  - session-guarding
  - memory-extraction
  - internal-prompt
  - recursion-prevention
  - hooks
applies_to: 'file:src/prompts/memory-extraction.ts'
occurred_at: '2025-12-21T19:23:11.524Z'
content_hash: 309f30812562285d
---
The memory extraction prompt generated by `buildMemoryExtractionPrompt()` was missing the `[LOCAL_RECALL_INTERNAL]` prefix guard. This caused the UserPromptSubmit hook to process memory extraction prompts as regular user prompts, creating recursion loops. The fix: prepend `[LOCAL_RECALL_INTERNAL]` to the start of the memory extraction prompt so the hook at line 161 of `user-prompt-submit.ts` correctly detects and skips it.
