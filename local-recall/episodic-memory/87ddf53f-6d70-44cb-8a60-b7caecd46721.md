---
id: 87ddf53f-6d70-44cb-8a60-b7caecd46721
subject: Fix AbortError in user-prompt-submit hook from unhandled process timeout
keywords:
  - abort error
  - spawn timeout
  - user-prompt-submit
  - process handling
  - child process
  - error handling
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T19:21:11.638Z'
content_hash: e495c107fbc646eb
---
# AbortError in callClaudeForKeywords Function

## Problem
The `callClaudeForKeywords` function in the user-prompt-submit hook was throwing an unhandled AbortError when the spawned child process timed out. This occurred because:

1. The `spawn` function was configured with a `timeout` option (line 41)
2. When Node.js aborts a process due to timeout, it throws an `AbortError`
3. This abort error wasn't being properly caught, causing an unhandled promise rejection
4. There were also duplicate `child.on('close', ...)` event handlers that could cause race conditions

## Solution
Applied the following fixes:

1. **Removed the `timeout` option from `spawn`** - This prevents Node.js from automatically killing the process and throwing AbortError
2. **Added `safeResolve` wrapper function** - Ensures the promise only resolves once, preventing race conditions between timeout logic and normal process completion
3. **Removed duplicate `close` handler** - Consolidated the two `child.on('close', ...)` listeners into a single handler to prevent duplicate event handling
4. **Added early-exit guards** - The `close` handler now checks if the promise has already been resolved before attempting to resolve again

## Impact
These changes eliminate the unhandled AbortError and prevent race conditions in child process handling within the hook.
