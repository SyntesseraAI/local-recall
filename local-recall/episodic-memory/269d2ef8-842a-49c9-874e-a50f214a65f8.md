---
id: 269d2ef8-842a-49c9-874e-a50f214a65f8
subject: MCP server concurrency issue with shared codebase folders
keywords:
  - mcp
  - concurrency
  - race condition
  - index
  - multiple-instances
  - stdio
applies_to: global
occurred_at: '2025-12-21T19:16:47.225Z'
content_hash: f2dd1cd92417dee2
---
When multiple Claude Code instances run on the SAME codebase folder, each spawns its own MCP server process (stdio isolation). However, they all write to the same `orama-episodic-index.json`, `orama-thinking-index.json`, and `processed-log.jsonl` files.

**Problem**: Without file locking or mutex protection, concurrent writes from multiple server instances can:
- Corrupt index files (partial writes, invalid JSON)
- Miss processed transcripts (race condition in processed-log checks)
- Create duplicate memories

**Solution**: Implement file-level locking using `proper-lockfile` npm package:
1. Acquire lock before reading/writing index and log files
2. Use atomic file operations (write to temp file, then rename)
3. Add timeout and stale lock cleanup
4. Test with multiple concurrent Claude instances on same folder

**Files affected**: `src/core/vector-store.ts`, `src/core/episodic-jsonl-store.ts`, `src/core/thinking-jsonl-store.ts`, `src/core/processed-log.ts`
