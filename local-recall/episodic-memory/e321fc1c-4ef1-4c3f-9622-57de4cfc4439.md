---
id: e321fc1c-4ef1-4c3f-9622-57de4cfc4439
subject: Mutex lock failed error in UserPromptSubmit hook - sqlite-vec loading issue
keywords:
  - mutex
  - sqlite-vec
  - hook error
  - file locking
  - libc++abi
  - concurrent access
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T18:20:26.357Z'
content_hash: 4a036b65c3869cd8
---
# UserPromptSubmit Hook Mutex Error

## Problem
The hook was throwing: `libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument`

## Root Cause
The hook directly instantiates `SearchEngine` and `ThinkingSearchEngine` which load sqlite-vec native bindings. This causes mutex contention when multiple processes try to acquire database locks simultaneously.

## Solution Applied
Improved logging was added to track the issue:
- PID logging in all database operations to identify which process is running
- Lock acquisition logging with attempt counts and elapsed time
- Detailed timing around `sqliteVec.load(db)` call
- Full stack traces on failure for better debugging

## Files Modified
- `src/utils/database.ts` - Enhanced lock and sqlite-vec load logging
- `src/hooks/user-prompt-submit.ts` - Better error handling and timing information

## Architecture Note
The hook architecture should use HTTP daemon for search instead of direct sqlite-vec loading to avoid these concurrent access issues.
