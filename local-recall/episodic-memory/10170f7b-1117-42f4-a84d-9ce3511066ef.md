---
id: 10170f7b-1117-42f4-a84d-9ce3511066ef
subject: >-
  UserPromptSubmit hook causes mutex error due to direct sqlite-vec loading in
  Claude Code process
keywords:
  - mutex error
  - sqlite-vec
  - hook
  - file locking
  - process isolation
  - system_error
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T18:19:08.315Z'
content_hash: 9cc87bef4980955a
---
The UserPromptSubmit hook was throwing 'libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument' when trying to load sqlite-vec directly in the Claude Code hook process.

Root cause: The hook instantiates SearchEngine and ThinkingSearchEngine which load sqlite-vec (via src/utils/database.ts:152, sqliteVec.load(db)), causing mutex contention in the hook's sandboxed process.

Solution implemented: Added comprehensive PID-based logging to trace process execution and lock acquisition timing to help identify where mutex failures occur. Logging includes:
- [PID:xxxx] prefix on all messages
- Lock acquisition attempt counts and elapsed time
- sqlite-vec load timing with separate vec load vs total time
- Full stack traces on failure

This helps distinguish between multiple processes (hook, daemon, MCP server) and debug file lock contention issues.
