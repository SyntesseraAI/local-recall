---
id: 89c0fbcd-76d2-47b6-ac19-6ef0f7b43f3f
subject: File-based locking prevents sqlite-vec concurrent initialization errors
keywords:
  - locking
  - concurrency-control
  - file-lock
  - sqlite-vec
  - synchronization
applies_to: 'file:src/utils/database.ts'
occurred_at: '2025-12-21T18:17:33.752Z'
content_hash: e1a504853746dc1b
---
Implemented a file-based locking mechanism using `openSync()` and `closeSync()` with a `.lock` file at `<dbPath>.lock`. Multiple processes wait for lock acquisition with exponential backoff (starting at 10ms, max 2000ms). Lock files older than 30 seconds are considered stale and forcibly removed to prevent deadlocks. This serializes sqlite-vec extension loading while allowing concurrent database operations once the extension is initialized.
