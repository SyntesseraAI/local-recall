---
id: e604efd9-94c8-4746-9013-cb7fb3944c0a
subject: >-
  File-based lock pattern for serializing database access across multiple
  processes
keywords:
  - locking
  - file-lock
  - concurrent
  - process-safety
  - timeout
applies_to: 'file:src/utils/database.ts'
occurred_at: '2025-12-21T18:16:42.322Z'
content_hash: 9d9eaf4eac1d6a35
---
Implemented file-based locking in `waitForDatabaseLock()` function to prevent concurrent sqlite-vec loading. Creates lock file (`db-lock.tmp`), checks for stale locks (older than 3 seconds), and uses busy-wait loop with exponential backoff. Ensures only one process loads sqlite-vec extension at a time. Lock is released in finally block to guarantee cleanup even on errors.
