---
id: 731cfc48-6065-44fb-91b4-0781ff98d954
subject: >-
  File-based semaphore locks serialize fastembed access across concurrent hook
  processes
keywords:
  - proper-lockfile
  - file lock
  - fastembed
  - mutex solution
  - embedding serialization
applies_to: 'file:src/core/embedding.ts'
occurred_at: '2025-12-21T19:22:44.635Z'
content_hash: 7ebd5b9f2ae9b658
---
Implemented file-based locking using `proper-lockfile` package to serialize access to fastembed/onnxruntime-node native modules. Lock is acquired at both initialization and embedding operation levels.

**Implementation details:**
- Lock file: `/tmp/local-recall-embedding.lock`
- Retries: 10 with exponential backoff (100ms - 2s)
- Stale lock timeout: 30 seconds
- Wraps both `initialize()` and `embed()` methods
- Logs "Acquired embedding lock" and "Released embedding lock" for debugging

This prevents concurrent access to the native module without requiring a daemon architecture, allowing hooks to run independently while safely sharing the resource.
