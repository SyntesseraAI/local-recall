---
id: 131b7ad2-0ff4-499a-bec9-984942628442
subject: User prompt hook AbortError caused by unhandled spawn timeout
keywords:
  - abort error
  - spawn timeout
  - user-prompt-submit
  - async error handling
  - child process
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T18:28:08.458Z'
content_hash: e0aa7b1db648e09e
---
## Problem
The user-prompt-submit hook was throwing an unhandled AbortError when calling Claude for keyword extraction. The error originated from Node.js aborting a child process due to the spawn timeout option.

## Root Cause
The `callClaudeForKeywords` function in user-prompt-submit.ts had two critical issues:
1. The `spawn` function was called with a `timeout` option that caused Node.js to abort the child process when exceeded, throwing an AbortError
2. This abort error wasn't being caught properly in the promise chain
3. There were duplicate `child.on('close', ...)` event handlers (at lines 60 and 120) causing race conditions

## Solution
1. Removed the `timeout` option from `spawn` - instead relying on manual timeout logic with proper error handling
2. Added a `safeResolve` wrapper to ensure the promise only resolves once, preventing race conditions
3. Removed the duplicate `close` handler to prevent multiple resolution attempts
4. Added early-exit guard in the close handler to prevent reprocessing

## Impact
This fix prevents the AbortError from propagating uncaught and ensures the hook completes gracefully even when Claude process calls timeout or fail.
