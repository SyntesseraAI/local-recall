---
id: 402a7e97-b40a-4b0b-9859-d0d2deac69ab
subject: File-based locking mechanism prevents sqlite-vec concurrent loading crashes
keywords:
  - sqlite-vec
  - mutex
  - file-lock
  - concurrency
  - database
  - hook
applies_to: 'file:src/utils/database.ts'
occurred_at: '2025-12-21T19:14:44.781Z'
content_hash: 8b2855ba8a9d46b5
---
The `sqlite-vec.load(db)` function crashes with a C++ runtime mutex error when called concurrently from multiple hook processes. This cannot be caught in JavaScript.

Implemented file-based locking in `loadDatabase()` to prevent concurrent sqlite-vec initialization:
1. Creates a lock file (`<db-path>.lock`) before loading sqlite-vec
2. Waits with exponential backoff if lock exists (checks every 10ms, max 1000 iterations)
3. Removes lock file after initialization
4. Detects and removes stale locks (older than 30 seconds)

This serializes sqlite-vec loading across concurrent hook invocations while remaining non-blocking for normal database operations.
