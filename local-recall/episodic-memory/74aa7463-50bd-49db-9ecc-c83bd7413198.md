---
id: 74aa7463-50bd-49db-9ecc-c83bd7413198
subject: File-based locking solution for fastembed/onnxruntime
keywords:
  - proper-lockfile
  - embedding lock
  - file lock
  - serialization
  - concurrency
applies_to: 'file:src/core/embedding.ts'
occurred_at: '2025-12-21T18:27:48.862Z'
content_hash: 22f1e607cb63dfc5
---
Implemented file-based locking using `proper-lockfile` package to serialize access to fastembed's onnxruntime-node native bindings. Lock file located at `/tmp/local-recall-embedding.lock`. Both `initializeEmbedding()` and embedding inference operations are wrapped with lock acquisition (retries: 10, stale timeout: 30s). This prevents mutex errors from concurrent hook processes trying to load the native module simultaneously.
