---
id: 29dde8c3-6940-4ca9-916f-04c26a95867c
subject: 'ONNX runtime causes mutex errors in concurrent hook processes, not sqlite-vec'
keywords:
  - onnx
  - mutex
  - concurrency
  - fastembed
  - embedding
  - threading
applies_to: global
occurred_at: '2025-12-21T19:19:54.289Z'
content_hash: 65eed77902820b39
---
The mutex errors experienced when running concurrent hooks are caused by ONNX runtime (used by fastembed), not sqlite-vec. The recent migration to Orama fixed SQLite issues, but ONNX runtime has internal mutex conflicts when multiple processes try to load the embedding model simultaneously. The `proper-lockfile` file-based locking mechanism cannot prevent ONNX's system-level mutex issues. Testing with 15 concurrent processes confirmed 15 mutex errors.

**Root cause**: `src/core/embedding.ts` uses fastembed which relies on ONNX native runtime. When `user-prompt-submit.ts` hook instantiates `SearchEngine`/`ThinkingSearchEngine`, each process loads ONNX concurrently, triggering mutex conflicts.

**Why session-start hook is safe**: It only uses `MemoryManager` (file-based, no embeddings) and doesn't load the embedding model.
