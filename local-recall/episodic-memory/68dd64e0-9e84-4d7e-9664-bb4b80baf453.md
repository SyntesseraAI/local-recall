---
id: 68dd64e0-9e84-4d7e-9664-bb4b80baf453
subject: Duplicate event handlers in async child process patterns cause race conditions
keywords:
  - child process
  - event handlers
  - race condition
  - promise
  - close event
applies_to: global
occurred_at: '2025-12-21T18:28:08.458Z'
content_hash: 87eca5e4048e69f4
---
## Pattern Issue
When working with child processes in Node.js and promises, having multiple event listeners for the same event (like `close`) can cause race conditions where the promise resolves multiple times.

## Why This Matters
In the user-prompt-submit hook's `callClaudeForKeywords` function, having two `child.on('close', ...)` handlers meant:
- Both handlers could execute when the process closes
- Both could attempt to resolve the promise
- This creates unpredictable behavior and potential resource leaks

## Best Practice
- Use a single event handler or combine logic into one handler
- Use a "safeResolve" wrapper that ensures the promise only resolves once
- Consider using `once()` instead of `on()` for single-fire events like `close`
