---
id: 92485894-5f01-4479-a26b-aa99e01e4b79
subject: SQLite concurrent access race condition between episodic and thinking hooks
keywords:
  - sqlite
  - race-condition
  - mutex
  - hooks
  - concurrent-access
  - thinking-vector-store
applies_to: global
occurred_at: '2025-12-21T18:29:45.308Z'
content_hash: d218176e4eea5214
---
Both `user-prompt-submit.js` and `user-prompt-submit-thinking.js` hooks run as separate processes and attempt to access the same `memory.sqlite` database simultaneously. This creates a race condition where the `sqlite-vec` extension's native C++ mutex fails with error: `libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument`. The hooks need to either use JSON-based indexes (like Orama) instead of SQLite, or implement cross-process locking mechanisms.
