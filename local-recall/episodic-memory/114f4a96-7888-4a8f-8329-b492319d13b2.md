---
id: 114f4a96-7888-4a8f-8329-b492319d13b2
subject: >-
  UserPromptSubmit hook performs semantic search on user input to inject
  contextual memories
keywords:
  - hooks
  - user-prompt-submit
  - semantic-search
  - vector-store
  - context-injection
  - lazy-initialization
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-02T12:27:44.947Z'
content_hash: 231894063650941e
---
# UserPromptSubmit Hook - Semantic Search Integration

## Purpose

The UserPromptSubmit hook runs when a user submits a prompt, before Claude processes it. It performs semantic search to find relevant memories and inject them into the context.

## Implementation Flow

1. **Receives input**: JSON with `session_id`, `transcript_path`, `cwd`, `prompt`
2. **Lazy initialization**: Vector store is initialized on first use (not on every session start)
3. **Semantic search**: Uses vector embeddings to find relevant memories
4. **Context injection**: Outputs matching memories to stdout
5. **Claude receives**: Memories are automatically injected into the context before Claude processes the prompt

## Key Technical Details

- Vector store is cached after first initialization (performance optimization)
- Uses cosine similarity for relevance scoring
- Results are ranked by similarity score with recency as tie-breaker
- Timeout: 30 seconds (as configured in hooks.json)

## Why Lazy Initialization?

The vector store takes time to initialize (needs to load embeddings model and build index from SQLite). Deferring this until the first user prompt ensures faster session starts while still providing semantic search during the session.

## Related Files

- `src/core/vector-store.ts` - Vector store implementation
- `src/core/search.ts` - Search implementation using vector embeddings
- `src/core/embedding.ts` - Embedding service (fastembed with BGE-small-en-v1.5)
