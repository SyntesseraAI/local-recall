---
id: 6bb268d3-cddb-447d-85aa-3ef20328c7f5
subject: >-
  Use [LOCAL_RECALL_INTERNAL] token prefix to prevent UserPromptSubmit hook
  recursion
keywords:
  - recursion guard
  - internal prompts
  - hook loop
  - token prefix
  - mcp disable
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T19:18:58.237Z'
content_hash: ee1266e10c810388
---
To prevent UserPromptSubmit from recursively firing when calling `claude -p` for memory extraction:

1. Prefix internal prompts with `[LOCAL_RECALL_INTERNAL]` token
2. In the hook, check `inputJSON.prompt.startsWith('[LOCAL_RECALL_INTERNAL]')` and return early if true
3. When calling `claude -p` for extraction, prepend the token to the prompt
4. Pass `--strict-mcp-config` parameter to disable MCP servers during the extraction subprocess

This allows testing with extraction-related prompts without triggering the guard, since the guard checks for the token rather than specific text content.
