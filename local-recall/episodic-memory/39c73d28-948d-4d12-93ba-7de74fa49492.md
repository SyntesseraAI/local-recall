---
id: 39c73d28-948d-4d12-93ba-7de74fa49492
subject: ONNX runtime mutex errors prevent concurrent embedding model loading in hooks
keywords:
  - mutex
  - onnx
  - concurrency
  - embeddings
  - fastembed
  - locking
applies_to: global
occurred_at: '2025-12-21T19:20:35.399Z'
content_hash: e48d514f2ca55c11
---
The mutex errors encountered were from ONNX runtime (fastembed backend), not sqlite-vec. When multiple Claude instances run simultaneously, their hooks all try to load the ONNX embedding model concurrently, triggering system-level mutex conflicts. The `proper-lockfile` file-based locking cannot prevent ONNX's internal mutex issues.

Tested with 3 batches of concurrent processes and confirmed 15 mutex errors from 15 concurrent processes.

Root cause: `user-prompt-submit.ts` hook directly instantiates SearchEngine which loads the embedding model. File-based locking is insufficient for ONNX runtime's native mutex protection.

**Solution**: Use Ollama as a shared embedding daemon. One process loads ONNX once, multiple clients call via HTTP API. This prevents the concurrent initialization that causes mutex conflicts.
