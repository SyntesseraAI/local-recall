---
id: 21decaa6-9696-4288-90dc-2d87aa47cb8a
subject: File-based locking pattern for concurrent native module access
keywords:
  - locking
  - proper-lockfile
  - embedding
  - concurrency
  - native modules
applies_to: 'file:src/core/embedding.ts'
occurred_at: '2025-12-21T18:27:48.823Z'
content_hash: 90a6d70570c6b8fb
---
Implemented file-based locking using proper-lockfile package to protect both EmbeddingService initialization and embedding operations. This prevents concurrent access to onnxruntime-node which has non-thread-safe native bindings.

Implementation:
- Lock path: `/tmp/local-recall-embedding.lock`
- Retries: 10 with exponential backoff
- Stale lock timeout: 30 seconds
- Locks both `initialize()` and `embed()` methods
- Logs 'Acquired embedding lock' and 'Released embedding lock' for debugging
