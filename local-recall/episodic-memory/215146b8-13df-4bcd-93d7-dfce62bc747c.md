---
id: 215146b8-13df-4bcd-93d7-dfce62bc747c
subject: >-
  SQLite database mutex lock errors from concurrent hook access - both episodic
  and thinking hooks try to access same database
keywords:
  - sqlite
  - mutex
  - concurrency
  - thinking-vector-store
  - race-condition
  - hooks
  - user-prompt-submit
applies_to: global
occurred_at: '2025-12-21T19:23:44.640Z'
content_hash: 4f812fd46dce5886
---
Both `user-prompt-submit.js` (episodic) and `user-prompt-submit-thinking.js` (thinking) hooks fire simultaneously and try to access the same SQLite database file. This creates a race condition where concurrent access causes the sqlite-vec native extension's mutex to fail with: `libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument`

Root cause: Two separate hook processes opening the same `memory.sqlite` file concurrently. The native C++ layer cannot handle this concurrent access pattern.

Solution: Keep hooks read-only and move all write operations to the background daemon which has exclusive control.
