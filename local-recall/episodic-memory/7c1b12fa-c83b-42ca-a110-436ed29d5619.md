---
id: 7c1b12fa-c83b-42ca-a110-436ed29d5619
subject: >-
  Concurrent database initialization requires file-based locking due to
  sqlite-vec C++ constraints
keywords:
  - sqlite-vec
  - concurrency
  - native extension
  - database
  - initialization
applies_to: 'area:database'
occurred_at: '2025-12-03T09:47:36.366Z'
content_hash: 7496ee74f5f3b4bc
---
The sqlite-vec native extension (C++ binding) has thread-safety issues when loaded concurrently by multiple processes. When multiple hooks try to initialize the database in parallel, sqlite-vec.load() throws a mutex lock error. The solution is file-based locking (not process locks) in `src/utils/database.ts`:

- Creates a `db-init.lock` file to serialize sqlite-vec loading
- Processes wait to acquire the lock file before calling sqlite-vec.load()
- Lock is released immediately after successful initialization
- Stale locks are cleaned up to prevent deadlocks

This is a workaround for the C++ extension's inability to handle concurrent initialization.
