---
id: da5d30ba-ea01-4294-9c74-c8cc769068ff
subject: Fix AbortError in user-prompt-submit hook from spawn timeout
keywords:
  - abort error
  - spawn timeout
  - user-prompt-submit
  - child process
  - error handling
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-01T16:27:26.632Z'
content_hash: 1bb06b273500eeac
---
The user-prompt-submit hook was throwing an unhandled AbortError when calling Claude for keyword extraction. The root cause was the `timeout` option in the `spawn()` call (line 41) which causes Node.js to abort the child process, throwing an AbortError that wasn't being caught. Additionally, there were duplicate `child.on('close', ...)` handlers (lines 60 and 120) creating race conditions.

Fix applied:
1. Removed the `timeout` option from spawn - Node.js's timeout mechanism throws AbortError which doesn't integrate well with promise-based error handling
2. Added a `safeResolve` wrapper to ensure the promise only resolves once
3. Removed duplicate close event handlers to prevent race conditions
4. Added early-exit guards to prevent multiple resolutions

This ensures proper error handling and prevents unhandled promise rejections when the Claude process takes longer than expected.
