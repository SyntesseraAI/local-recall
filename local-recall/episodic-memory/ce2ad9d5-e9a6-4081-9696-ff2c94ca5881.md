---
id: ce2ad9d5-e9a6-4081-9696-ff2c94ca5881
subject: ONNX runtime mutex errors prevent concurrent hook execution
keywords:
  - onnx
  - mutex
  - concurrency
  - fastembed
  - embedding
  - hooks
  - threading
applies_to: global
occurred_at: '2025-12-21T18:26:49.611Z'
content_hash: cd1cd249075d8edd
---
The mutex errors observed during concurrent hook execution are caused by ONNX runtime (used by fastembed), not sqlite-vec. When multiple processes try to load the ONNX embedding model simultaneously, they encounter system-level mutex conflicts. This prevents hooks from being safely executed by multiple Claude instances running concurrently.

Root cause: `user-prompt-submit.ts` directly instantiates `SearchEngine`/`ThinkingSearchEngine`, which load the embedding model via fastembed. The `proper-lockfile` file-based locking doesn't prevent ONNX's internal mutex issues.

This is a fundamental limitation of ONNX runtime's concurrency model, not a Local Recall-specific issue. The workaround requires either: (1) using a shared embedding daemon like Ollama, or (2) switching to a pure-JavaScript embedding library without native dependencies.
