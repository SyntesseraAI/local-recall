---
id: 77541edf-5863-408f-a663-80acd291e11f
subject: >-
  UserPromptSubmit hook: Unified search handling both episodic and thinking
  memories
keywords:
  - userpromptsubmit
  - hook
  - semantic search
  - unified search
  - episodic
  - thinking
  - memory injection
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T19:04:31.826Z'
content_hash: 9f388c5faf23a9d0
---
## Purpose

The UserPromptSubmit hook is triggered when a user submits a prompt. It searches for relevant memories (both episodic and thinking) and injects them into Claude's context before processing.

## Flow

1. **Input** (JSON via stdin):
   - `session_id` - Current session identifier
   - `transcript_path` - Path to transcript
   - `cwd` - Current working directory
   - `prompt` - The user's prompt text

2. **Skip internal prompts**:
   - Skips prompts containing `[LOCAL_RECALL_INTERNAL]` (used for memory extraction)
   - This prevents memory extraction prompts from triggering memory searches

3. **Search episodic memories** (if enabled):
   - Uses Orama vector store + Ollama embeddings
   - Filters by `episodicMinSimilarity` threshold
   - Respects `episodicMaxTokens` budget
   - Returns ranked results with similarity scores

4. **Search thinking memories** (if enabled):
   - Uses separate Orama vector store
   - Filters by `thinkingMinSimilarity` threshold
   - Respects `thinkingMaxTokens` budget
   - Returns ranked results with similarity scores

5. **Output** (stdout):
   - Combined results from both searches
   - Formatted for injection into Claude's context
   - Includes similarity scores and metadata

## Configuration

**Episodic**:
- `LOCAL_RECALL_EPISODIC_ENABLED` - Enable/disable (default: true)
- `LOCAL_RECALL_EPISODIC_MAX_TOKENS` - Token budget (default: 1000)
- `LOCAL_RECALL_EPISODIC_MIN_SIMILARITY` - Threshold 0.0-1.0 (default: 0.5)

**Thinking**:
- `LOCAL_RECALL_THINKING_ENABLED` - Enable/disable (default: true)
- `LOCAL_RECALL_THINKING_MAX_TOKENS` - Token budget (default: 1000)
- `LOCAL_RECALL_THINKING_MIN_SIMILARITY` - Threshold 0.0-1.0 (default: 0.5)

## Key Design

- **Independent searches**: Episodic and thinking are searched separately
- **Separate thresholds**: Each can have different quality bars
- **Combined output**: Results are merged and formatted together
- **No duplicates**: Same memory isn't included twice even if matching multiple searches
