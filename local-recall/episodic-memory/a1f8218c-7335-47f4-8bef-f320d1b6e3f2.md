---
id: a1f8218c-7335-47f4-8bef-f320d1b6e3f2
subject: File-based locking implementation for cross-process database access
keywords:
  - file-locking
  - database
  - mutex
  - concurrency
  - cross-process
applies_to: 'file:src/utils/database.ts'
occurred_at: '2025-12-03T10:13:19.759Z'
content_hash: ee5b1c22f95a6d51
---
Added `withDbMutex(dbPath, operation)` function that uses file-based locking to serialize database operations across processes:

- Creates lock file: `{dbPath}.lock`
- Implements spin-lock with 10ms polling (max 30 second timeout)
- Includes stale lock detection (locks older than 5 minutes are forcefully released)
- Wraps entire database operation, from connection open to operation completion
- Works across both hooks (separate processes) and daemon (single process)

All VectorStore and ThinkingVectorStore operations now use `withDbMutex(this.dbPath, ...)` to ensure safe concurrent access.
