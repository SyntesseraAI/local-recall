---
id: 02e97ba8-fb1c-4579-9753-9fcf7757e1d6
subject: Fix AbortError in user-prompt-submit hook from spawn timeout
keywords:
  - user-prompt-submit
  - spawn
  - timeout
  - abort
  - error-handling
  - child-process
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T18:26:12.039Z'
content_hash: 2df5868eda9443b5
---
## Problem
The `callClaudeForKeywords` function in user-prompt-submit.ts was throwing unhandled `AbortError` when spawning child processes. The Node.js `spawn` timeout option automatically aborts the process after the timeout, but the abort error wasn't being caught.

## Root Cause
1. The `spawn` call had a `timeout` option that kills the child process without proper error handling
2. Duplicate `child.on('close', ...)` event handlers (at lines 60 and 120) could cause race conditions
3. No safeguard to ensure the promise resolves only once

## Solution
1. **Remove spawn timeout option** - Node.js built-in timeout throws AbortError which requires specific error handling
2. **Add safeResolve wrapper** - Implement promise wrapper that ensures single resolution, preventing race conditions
3. **Remove duplicate close handlers** - Keep only one event listener to prevent multiple resolutions
4. **Add early-exit guard** - Check if promise already resolved before executing close handler logic

## Implementation Details
The fix uses a resolved flag pattern to track promise resolution state and prevents duplicate event handlers from firing.
