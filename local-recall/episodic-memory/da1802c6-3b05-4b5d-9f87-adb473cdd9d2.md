---
id: da1802c6-3b05-4b5d-9f87-adb473cdd9d2
subject: >-
  File-based locking (proper-lockfile) serializes fastembed access across hook
  processes
keywords:
  - file-lock
  - proper-lockfile
  - semaphore
  - embedding
  - serialization
applies_to: 'file:src/core/embedding.ts'
occurred_at: '2025-12-21T18:30:01.408Z'
content_hash: 3d9fdbbd0e8d5ff6
---
Implemented proper-lockfile to serialize fastembed/onnxruntime-node access across concurrent hook processes:

- Lock file: `/tmp/local-recall-embedding.lock`
- Retries: 10 with exponential backoff (100ms - 2s)
- Stale timeout: 30 seconds
- Both `initialize()` and `embed()` methods acquire locks before executing
- Provides 'Acquired embedding lock' / 'Released embedding lock' debug logs

This prevents concurrent native module initialization and inference operations that trigger mutex errors.
