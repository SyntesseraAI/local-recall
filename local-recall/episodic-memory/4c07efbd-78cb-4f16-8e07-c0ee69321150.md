---
id: 4c07efbd-78cb-4f16-8e07-c0ee69321150
subject: >-
  VectorStore and ThinkingVectorStore must wrap all database operations with
  file locks
keywords:
  - vector-store
  - database-operations
  - locking
  - search
  - sync
applies_to: 'file:src/core/vector-store.ts'
occurred_at: '2025-12-21T19:11:29.598Z'
content_hash: 1cc829fe4c5bcbda
---
All database operations in VectorStore must use `withDbMutex(this.dbPath, ...)` to prevent concurrent access:

- `initialize()` - loads index or creates new one
- `add()` - inserts embeddings
- `remove()` - deletes embeddings
- `search()` - vector similarity search
- `sync()` - reconciles file-based memories with store
- `persist()` - saves index to JSON

Same pattern applies to ThinkingVectorStore. The dbPath is stored as instance variable during construction via `getOrCreateDatabase()`.
