---
id: 2b00fb0b-931e-49ed-8e6b-65ced6cc24bf
subject: File-based locking approach resolves concurrent native module access in hooks
keywords:
  - proper-lockfile
  - concurrency control
  - file lock
  - embedding.ts
  - native modules
  - serialization
applies_to: 'file:src/core/embedding.ts'
occurred_at: '2025-12-21T18:28:55.282Z'
content_hash: bafc82ed1c6c36dc
---
Implemented proper-lockfile-based file locking to serialize access to fastembed/onnxruntime-node in `src/core/embedding.ts`. The lock is acquired during both `doInitialize()` and `embed()` operations using `withEmbeddingLock()` wrapper. Lock file location: `/tmp/local-recall-embedding.lock`. This prevents the mutex contention errors that occur when multiple hook processes try to load the native module simultaneously.
