---
id: 450ec925-0972-4982-9334-fcc75a0c9f41
subject: >-
  Recursion guard using [LOCAL_RECALL_INTERNAL] token prevents infinite hook
  loops
keywords:
  - recursion prevention
  - hook guard
  - internal prompts
  - user prompt submit
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T18:26:30.211Z'
content_hash: 613fb1f7a5e235b1
---
The UserPromptSubmit hook can recursively fire when calling `claude -p` for memory extraction. Prevent this by: 1) Prefixing internal extraction prompts with `[LOCAL_RECALL_INTERNAL]` token, 2) Checking `prompt.startsWith('[LOCAL_RECALL_INTERNAL]')` to skip processing, 3) Using `--strict-mcp-config` flag to disable MCP servers during extraction subprocess. This token-based approach is better than content-based checks because it allows testing with extraction-related prompts without triggering the guard.
