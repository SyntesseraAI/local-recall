---
id: 66d2f5e8-be95-487d-8fcf-25ef4d3e9460
subject: >-
  user-prompt-submit hook directly loads embedding model, causing concurrency
  issues
keywords:
  - user-prompt-submit
  - hook
  - embedding
  - search engine
  - concurrency
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T19:19:42.881Z'
content_hash: ebca6b854f54b755
---
The user-prompt-submit hook directly instantiates SearchEngine and ThinkingSearchEngine, which both load the embedding model via getVectorStore and getThinkingVectorStore. This direct model loading in each hook execution causes ONNX mutex conflicts when multiple Claude instances run simultaneously. In contrast, session-start hook only uses MemoryManager (file-based, no embeddings) and is safe.
