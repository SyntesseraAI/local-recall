---
id: 4ff961ee-aa30-4d1c-b611-3c0af40bbd84
subject: Token-based retrieval for thinking memories with configurable limits
keywords:
  - thinking memory retrieval
  - token budget
  - similarity threshold
  - configuration
  - memory injection
applies_to: 'area:thinking-memory'
occurred_at: '2025-12-21T19:14:45.298Z'
content_hash: 0e4c4ca1fdcfec9f
---
Thinking memories are now retrieved using a token-based budget system instead of a fixed count. This allows better control over memory injection size.

Configuration:
- `LOCAL_RECALL_THINKING_MAX_TOKENS` (env var, default: 1000) - max tokens of thinking memories to inject
- `LOCAL_RECALL_THINKING_MIN_SIMILARITY` (env var, default: 0.8) - minimum similarity threshold (0.0-1.0)

Retrieval logic in `src/hooks/user-prompt-submit-thinking.ts`:
- Searches thinking memories by semantic similarity
- Filters by minimum similarity threshold
- Accumulates memories in order until token budget is exceeded
- Formats with thought + output sections

This replaces the previous count-based approach and provides more fine-grained control.
