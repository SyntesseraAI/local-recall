---
id: 13468f08-b387-46df-8d6c-5473e2dca96c
subject: Fix Claude response parsing for raw array memories in memory extractor
keywords:
  - memory-extractor
  - parseClaudeResponse
  - array-handling
  - zod-validation
  - json-parsing
  - bug-fix
applies_to: 'file:src/core/memory-extractor.ts'
occurred_at: '2025-12-01T16:07:19.481Z'
content_hash: b4744a55066f570f
---
## Bug Description
The `parseClaudeResponse` method in memory-extractor.ts (line 174) expected Claude CLI to return `{ memories: [...] }` but Claude (Haiku) sometimes returns a raw JSON array `[...]` instead.

## Root Cause
The prompt sent to Claude via `claude -p` didn't specify the exact JSON format required, allowing Claude flexibility in its output format. When Claude returns an array directly, the Zod validation fails with "Expected object, received array".

## Solution
Modified `parseClaudeResponse` to:
1. Try parsing as-is first
2. If that fails, check if the parsed value is an array
3. If it's an array, wrap it in `{ memories: ... }` format
4. Validate the wrapped result with Zod

This makes the parser resilient to both output formats while maintaining strict validation.

## File Location
src/core/memory-extractor.ts, lines 174-188

## Changed Code
The fix wraps raw arrays in the expected object format before validation, allowing both output styles from Claude CLI to be handled correctly.
