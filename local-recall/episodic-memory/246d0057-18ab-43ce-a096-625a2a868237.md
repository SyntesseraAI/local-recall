---
id: 246d0057-18ab-43ce-a096-625a2a868237
subject: >-
  Current architecture loads embedding model in hooks - incompatible with
  multiple Claude instances
keywords:
  - architecture
  - hooks
  - search-engine
  - vector-store
  - embedding
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T19:19:54.289Z'
content_hash: 58d86f52fd6f145c
---
The `user-prompt-submit.ts` hook directly instantiates `SearchEngine` and `ThinkingSearchEngine`, which trigger embedding model loading via `getVectorStore()` and `getThinkingVectorStore()`. This means each hook execution (each prompt in each Claude instance) attempts to load the ONNX embedding model, creating concurrency conflicts.

**Specific code path**: `user-prompt-submit.ts` → `SearchEngine` → `getVectorStore()` → `embedding.ts` (fastembed/ONNX initialization)

This design assumes a single Claude instance. With multiple instances, all hooks run concurrently and trigger simultaneous ONNX loads.
