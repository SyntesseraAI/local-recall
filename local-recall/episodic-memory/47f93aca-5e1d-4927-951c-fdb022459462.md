---
id: 47f93aca-5e1d-4927-951c-fdb022459462
subject: >-
  SQLite mutex lock failure when both episodic and thinking hooks run
  simultaneously
keywords:
  - sqlite
  - mutex
  - concurrent access
  - race condition
  - hooks
  - thinking hook
  - episodic hook
applies_to: global
occurred_at: '2025-12-21T18:29:49.579Z'
content_hash: 6a5422b063562b63
---
Both `user-prompt-submit.js` and `user-prompt-submit-thinking.js` hooks run as separate processes and try to access the same `memory.sqlite` file simultaneously. When both hooks fire on user prompt submit, they create a race condition where both try to initialize/lock the same SQLite database. The `sqlite-vec` extension's native mutex handling fails under concurrent access, throwing `std::__1::system_error: mutex lock failed: Invalid argument`.

The solution is to move thinking memory extraction to the MCP daemon where it can be serialized and run sequentially with episodic extraction (or with its own timing), rather than having it run as a concurrent hook process.
