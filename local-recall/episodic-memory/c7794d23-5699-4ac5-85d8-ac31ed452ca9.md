---
id: c7794d23-5699-4ac5-85d8-ac31ed452ca9
subject: Fix AbortError in user-prompt-submit hook from unhandled spawn timeout
keywords:
  - user-prompt-submit
  - spawn
  - timeout
  - AbortError
  - error handling
  - child process
  - promise
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T19:20:20.014Z'
content_hash: ddb547ea281a0a60
---
## Problem
The `callClaudeForKeywords()` function in user-prompt-submit.ts was throwing unhandled AbortError when the spawn timeout (line 41) killed the child process. Node.js aborts child processes when timeout expires, but this abort wasn't being caught properly.

## Root Causes
1. `spawn()` has a `timeout` option that kills the process and throws `AbortError` - this error wasn't wrapped in try-catch
2. Duplicate `child.on('close', ...)` event handlers (lines 60 and 120) causing race conditions
3. No synchronization to ensure promise resolves only once

## Solution Applied
1. Removed `timeout` option from `spawn()` call
2. Added `safeResolve()` wrapper that prevents multiple resolutions via a flag
3. Removed duplicate close handler - consolidated into single listener
4. Added early-exit guard in close handler to prevent duplicate processing

## Key Learning
Node.js child_process spawn's built-in timeout is problematic because it aborts the process asynchronously. Better to implement manual timeout handling or remove timeout entirely if process naturally completes.
