---
id: 1f6ef26f-80eb-44a3-b6ee-e4bdc8e864d2
subject: >-
  Claude Haiku sometimes returns raw array instead of object wrapper for memory
  extraction
keywords:
  - claude-haiku
  - parseClaudeResponse
  - json-parsing
  - array-handling
  - memory-extractor
applies_to: 'file:src/core/memory-extractor.ts'
occurred_at: '2025-12-01T16:13:32.843Z'
content_hash: cb0e166252ffa721
---
## Issue
The `parseClaudeResponse` method in `src/core/memory-extractor.ts` expected Claude Haiku to return memories wrapped in `{ memories: [...] }` format, but Haiku sometimes returns a raw array `[...]` instead.

## Root Cause
Claude's output format is inconsistent depending on the prompt structure. When the prompt asks for JSON output, Haiku may return either format depending on context.

## Solution
Enhance `parseClaudeResponse` to handle both formats:
1. Try parsing as JSON first
2. If it's an array, treat it as `{ memories: array }`
3. If it's an object with `memories` property, use that
4. Use Zod for validation to ensure consistent structure

## Implementation
The fix involves updating the parser to be more defensive about input format while maintaining validation through Zod schema.
