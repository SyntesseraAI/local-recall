---
id: b2c7a67c-2da6-4673-aa2c-0cf4d13ccb8e
subject: File-based locking mechanism prevents sqlite-vec concurrent loading issues
keywords:
  - sqlite-vec
  - mutex lock
  - concurrency
  - database
  - locking
  - file lock
applies_to: 'file:src/utils/database.ts'
occurred_at: '2025-12-03T09:47:36.366Z'
content_hash: 70ef0cea07ebaa62
---
The C++ sqlite-vec extension throws mutex lock errors when multiple processes try to load it simultaneously during parallel transcript processing. Implemented file-based locking in `src/utils/database.ts` to prevent concurrent sqlite-vec loading:

- Uses a `db-init.lock` file in the memory directory
- Acquires lock before calling `sqlite-vec.load(db)`
- Releases lock after initialization
- Cleans up stale locks (older than 30 seconds)
- Added try-catch wrapper to gracefully handle extension loading failures

This prevents the "unable to open shared object file" mutex errors when multiple hooks run in parallel.
