---
id: fed0a1ec-c8a0-4c74-8a2b-9fd20f17a07b
subject: 'Use [LOCAL_RECALL_INTERNAL] token to prevent UserPromptSubmit hook recursion'
keywords:
  - recursion guard
  - hook loop
  - internal prompts
  - token prefix
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T19:19:53.624Z'
content_hash: b4169e3cd2f83bf2
---
The UserPromptSubmit hook calls `claude -p` for memory extraction, which triggers another UserPromptSubmit event, creating infinite recursion.

Solution implemented:
1. Prefix internal extraction prompts with `[LOCAL_RECALL_INTERNAL]` token
2. Check `prompt.startsWith('[LOCAL_RECALL_INTERNAL]')` at hook start to skip processing
3. Pass `--strict-mcp-config` to `claude` subprocess to disable MCP servers

Using a token prefix instead of checking prompt content allows for easier testing - users can test with extraction-related prompts without triggering the guard.
