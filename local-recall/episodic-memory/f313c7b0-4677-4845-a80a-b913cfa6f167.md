---
id: f313c7b0-4677-4845-a80a-b913cfa6f167
subject: >-
  File locking mechanism exists in database.ts but mutex errors still occur in
  hook processes
keywords:
  - file locking
  - process safety
  - sqlite-vec
  - mutex
  - lock acquisition
applies_to: 'file:src/utils/database.ts'
occurred_at: '2025-12-21T18:19:08.315Z'
content_hash: d1d24afcecbc247f
---
The database.ts file has a file-locking mechanism (acquireLock/releaseLock functions) to prevent concurrent access to sqlite-vec, but mutex errors still occur when hooks try to load sqlite-vec directly.

The lock mechanism uses file-based synchronization but doesn't prevent the underlying sqlite-vec library from experiencing mutex contention when loaded in multiple processes simultaneously.

Logging improvements added:
- Lock acquisition shows attempt count and elapsed time
- sqliteVec.load(db) call is wrapped with timing information
- All operations include [PID:xxxx] prefix for process identification
- Stack traces capture full error context for debugging
