---
id: 6525ce45-25d0-42d6-8ab4-9bca29a8492e
subject: File-based locking mechanism for cross-process database safety
keywords:
  - file-lock
  - database
  - synchronization
  - cross-process
  - stale-lock
applies_to: 'file:src/utils/database.ts'
occurred_at: '2025-12-21T19:11:29.598Z'
content_hash: 49197f5656d2e0e4
---
Implemented `withDbMutex(dbPath, operation)` function that:

1. Creates a lock file next to the database (`{dbPath}.lock`)
2. Acquires lock with timeout (5 second retries with exponential backoff)
3. Detects stale locks (>10 seconds old) and removes them
4. Executes the operation with lock held
5. Releases lock in finally block

This ensures that all sqlite-vec operations are serialized across processes, preventing mutex corruption. Lock files are cleaned up automatically.
