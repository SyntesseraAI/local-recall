---
id: a1e9dba5-5c95-48f5-a28c-40740bfb1264
subject: >-
  user-prompt-submit hook directly loads embedding model, causing concurrency
  issues
keywords:
  - user-prompt-submit
  - embedding
  - concurrent
  - hook
  - search-engine
applies_to: 'file:src/hooks/user-prompt-submit.ts'
occurred_at: '2025-12-21T18:25:17.343Z'
content_hash: 688a815361ec1273
---
The user-prompt-submit hook instantiates SearchEngine and ThinkingSearchEngine directly, which load the embedding model on initialization. This causes mutex errors when multiple Claude instances execute the hook simultaneously. session-start.ts is safe because it only uses MemoryManager (file-based, no embeddings). To fix concurrent execution, either use Ollama daemon (one process, multiple clients) or switch to text-based search for hooks with vector search only in MCP tools.
