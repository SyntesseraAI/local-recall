---
id: a3b03207-7b6d-446e-a13c-76caed220071
subject: >-
  Found the issue! The `user-prompt-submit.ts` hook is loading `SearchEngine`
  and...
applies_to: global
occurred_at: '2025-12-03T11:12:57.918Z'
content_hash: 158e6fa25c38bc97
---
## Thought

Found the issue! The `user-prompt-submit.ts` hook is loading `SearchEngine` and `ThinkingSearchEngine` directly, which in turn load the `EmbeddingService` (using `fastembed`). This means:1. Each hook invocation loads `fastembed` and `onnxruntime-node`
2. When multiple hook processes run concurrently, they all try to load the native onnxruntime module
3. This causes the same mutex errors as before!

The original daemon architecture was designed to solve this - the hooks would call the daemon via HTTP, and only the daemon would load the native modules. But this was probably removed/changed when moving to Orama.

The solution is one of:
1. **Restore the daemon HTTP architecture** - hooks call daemon for search, daemon owns the native onnxruntime module
2. **Use a pure JavaScript embedding solution** - but fastembed with onnxruntime is currently the only fast local option
3. **Use text-based search instead of vector search in hooks** - fall back to simple keyword matching when doing direct hook invocation

Let me check if there's still a daemon/HTTP server available:

## Output

Found the problem! The hook is loading `SearchEngine`/`ThinkingSearchEngine` directly, which loads `fastembed` â†’ `onnxruntime-node` (native module). This causes the **same mutex issue** as sqlite-vec.

The original daemon architecture was meant to avoid this - let me check if the HTTP server is still available:
