---
id: f7fbaffe-a024-4ed4-bc5b-973c32c98991
subject: >-
  Excellent! Now I have a comprehensive understanding of the codebase. Let me
  think through the plan...
applies_to: global
occurred_at: '2025-12-02T21:55:58.824Z'
content_hash: 88279f35871ec80b
---
## Thought

Excellent! Now I have a comprehensive understanding of the codebase. Let me think through the plan carefully:

## Requirements Summary:
1. New "thinking-memories" index for A/B testing
2. Extract only "thinking" messages from Claude transcripts
3. Use vector search with timestamp weighting (same as current)
4. New UserPromptSubmit hook to inject as "previous thoughts"
5. Separate extraction process
6. Process 20 files in parallel
7. Same file format as memories but without keywords
8. New table in SQLite

## Architecture Plan:

### 1. New Types (`src/core/types.ts`)
- `ThinkingMemory` interface - same as Memory but without keywords
- `ThinkingMemoryFrontmatter` - omits keywords field

### 2. New Storage
- Location: `local-recall/thinking-memories/*.md`
- Same markdown format with YAML frontmatter, but no keywords

### 3. New SQLite Tables (`src/core/vector-store.ts`)
- `thinking_memories` table (similar to memories but no keywords column)
- `thinking_embeddings` virtual table (same as memory_embeddings)

### 4. New Thinking Memory Manager (`src/core/thinking-memory.ts`)
- Similar to memory.ts but for thinking memories
- CRUD operations for thinking memory files
- Handles deduplication

### 5. New Thinking Extractor (`src/core/thinking-extractor.ts`)
- Extract thinking blocks from transcripts
- Process 20 files in parallel (higher concurrency than current 5)
- Separate processed log tracking

### 6. New Vector Store Methods
- Add methods for thinking memories to existing vector-store.ts
- Or create separate thinking-vector-store.ts

### 7. New/Modified Hook
- Could be separate hook file or modify existing user-prompt-submit.ts
- Inject thinking memories as "previous thoughts"
 
I'll focus on potential integration strategies and configuration management. MCP tools might require custom adapters to handle thinking memories, ensuring seamless incorporation into existing infrastructure. Gitignore updates will prevent accidental tracking of sensitive thinking memory files, maintaining clean version control practices.

## Output

Now I have a comprehensive understanding. Let me create a detailed plan for your confirmation.

## Architecture Plan: Thinking-Memories Index

### Overview

Create a parallel "thinking-memories" system that extracts Claude's thinking blocks from transcripts for semantic search and context injection.

### Key Differences from Current Memories

| Aspect | Current Memories | Thinking Memories |
|--------|------------------|-------------------|
| Source | Full transcript → Claude extraction | Only `thinking` blocks |
| Keywords | Required (1-20) | **Omitted** |
| Location | `local-recall/episodic-memory/` | `local-recall/thinking-memories/` |
| SQLite Tables | `memories`, `memory_embeddings` | `thinking_memories`, `thinking_embeddings` |
| Parallelism | 5 concurrent | **20 concurrent** |
| Hook Output | "Relevant Memories" | **"Previous Thoughts"** |

---

### Implementation Plan

#### 1. New Types (`src/core/types.ts`)
```typescript
interface ThinkingMemoryFrontmatter {
  id: string;                    // UUID
  subject: string;               // Brief description (1-200 chars)
  // NO keywords field
  applies_to: MemoryScope;       // 'global' | 'file:...' | 'area:...'
  occurred_at: string;           // ISO-8601 timestamp
  content_hash: string;          // SHA-256 prefix (16 chars)
}

interface ThinkingMemory extends ThinkingMemoryFrontmatter {
  content: string;
}
```

#### 2. New File Storage
- **Location**: `local-recall/thinking-memories/`
- **Format**: Same markdown with YAML frontmatter (minus keywords)
- **Update**: `src/utils/gitignore.ts` to handle new directory

#### 3. New SQLite Tables (in existing `memory.sqlite`)
```sql
-- Metadata table (no keywords column)
CREATE TABLE thinking_memories (
  id TEXT PRIMARY KEY,
  subject TEXT NOT NULL,
  applies_to TEXT NOT NULL,
  occurred_at TEXT NOT NULL,
  content_hash TEXT NOT NULL,
  content TEXT NOT NULL
);

-- Vector embeddings (same structure)
CREATE VIRTUAL TABLE thinking_embeddings USING vec0(
  id TEXT PRIMARY KEY,
  embedding float[384]
);

-- Indexes
CREATE INDEX idx_thinking_memories_occurred_at ON thinking_memories(occurred_at DESC);
CREATE INDEX idx_thinking_memories_applies_to ON thinking_memories(applies_to);
```

#### 4. New Core Files

| File | Purpose |
|------|---------|
| `src/core/thinking-memory.ts` | CRUD operations for thinking memory files |
| `src/core/thinking-vector-store.ts` | Vector store methods for thinking memories (or extend existing) |
| `src/core/thinking-extractor.ts` | Extract thinking blocks, 20-file parallel processing |
| `src/core/thinking-processed-log.ts` | Track processed transcripts (separate log file) |

#### 5. Thinking Extractor Design (`src/core/thinking-extractor.ts`)

```
TranscriptCollector.listLocalTranscripts()
    ↓
For each transcript (20 in parallel):
    ↓
ThinkingProcessedLog.needsProcessing()
    ↓ (check content hash)
    ↓
parseTranscript() → extract all ThinkingContent blocks
    ↓
For each thinking block:
    - Generate subject from first ~100 chars
    - Determine applies_to from context
    - Create ThinkingMemory
    ↓
ThinkingMemoryManager.createMemory()
    ↓
ThinkingVectorStore.add()
    ↓
ThinkingProcessedLog.recordProcessed()
```

**Key difference**: No Claude API call needed - thinking blocks are used directly as content.

#### 6. New UserPromptSubmit Hook (`src/hooks/user-prompt-submit-thinking.ts`)

- Performs semantic search on `thinking_memories` table
- Injects results as "Previous Thoughts" section:

```markdown
# Local Recall: Previous Thoughts

Found X relevant thinking excerpts.

## Thought Subject
**ID:** uuid
**Scope:** applies_to
**Occurred:** timestamp

---
Thinking content here...
*Similarity: XX%*
---
```

#### 7. Hook Configuration Update

Add to `.claude/settings.json`:
```json
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node ./dist/hooks/user-prompt-submit.js",
            "timeout": 30
          },
          {
            "type": "command", 
            "command": "node ./dist/hooks/user-prompt-submit-thinking.js",
            "timeout": 30
          }
        ]
      }
    ]
  }
}
```

#### 8. File Structure (New Files)

```
src/
├── core/
│   ├── thinking-memory.ts           # NEW: CRUD for thinking memories
│   ├── thinking-vector-store.ts     # NEW: Vector store for thinking
│   ├── thinking-extractor.ts        # NEW: Extract thinking blocks (20 parallel)
│   └── thinking-processed-log.ts    # NEW: Track processed transcripts
├── hooks/
│   └── user-prompt-submit-thinking.ts  # NEW: Inject "previous thoughts"
└── prompts/
    └── thinking-subject-extraction.ts  # NEW: Generate subjects (optional)
```

#### 9. MCP Tools (Optional Extension)
- `thinking_memory_search` - Search thinking memories
- `thinking_memory_list` - List thinking memories
- `thinking_index_rebuild` - Rebuild thinking memory index

---

### Questions Before Implementation

1. **Subject generation**: Should I use Claude to generate a concise subject from each thinking block, or derive it automatically (first N characters, truncated)?

2. **applies_to scope**: Should all thinking memories be `global`, or should I try to infer scope from the transcript context (e.g., which files were being discussed)?

3. **Deduplication**: Should thinking memories be deduplicated by content hash alone, or also consider the transcript they came from?

4. **MCP tools**: Do you want MCP tools exposed for thinking memories, or just the hook injection?

5. **Integration**: Should the existing UserPromptSubmit hook be modified to also search thinking memories, or keep them as completely separate hooks?

---

Do you want me to proceed with this plan? Please confirm or let me know any adjustments.
