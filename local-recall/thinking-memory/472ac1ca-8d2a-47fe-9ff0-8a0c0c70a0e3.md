---
id: 472ac1ca-8d2a-47fe-9ff0-8a0c0c70a0e3
subject: >-
  The user is showing me logs that indicate a problem with the "session
  guarding" - it looks like the...
applies_to: global
occurred_at: '2025-11-30T14:56:45.607Z'
content_hash: fae8d629c81d50e1
---
## Thought

The user is showing me logs that indicate a problem with the "session guarding" - it looks like the UserPromptSubmit hook is not properly filtering out internal prompts that are being sent to Claude for memory extraction or keyword extraction.

Looking at the logs:
1. At 14:55:01.205Z - There's a prompt with "[LOCAL_RECALL_INTERNAL]" prefix that IS being correctly skipped: "Skipping internal Local Recall prompt to prevent recursion"
2. At 14:55:31.997Z - There's another prompt that looks like an internal memory extraction prompt (starts with "You are analyzing a Claude Code session transcript...") but it's NOT being skipped

The issue is that the second prompt doesn't have the "[LOCAL_RECALL_INTERNAL]" prefix, so it's not being caught by the guard.

Let me look at the user-prompt-submit.ts hook to understand how the guarding works and see what needs to be fixed.

## Output

Looking at the logs, I can see the issue. The `[LOCAL_RECALL_INTERNAL]` prefix guard is working for keyword extraction prompts, but the memory extraction prompt (starting with "You are analyzing a Claude Code session transcript...") doesn't have that prefix and isn't being filtered.

Let me check the current implementation:
