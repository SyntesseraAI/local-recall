---
id: af45fc00-d1d3-464f-af0c-c2ea6838103c
subject: >-
  I can see the issue. Both `VectorStore` and `ThinkingVectorStore` share the
  same SQLite database...
applies_to: global
occurred_at: '2025-12-03T08:33:59.323Z'
content_hash: dda9e0a2fae22412
---
## Thought

I can see the issue. Both `VectorStore` and `ThinkingVectorStore` share the same SQLite database file (`memory.sqlite`) but they have separate singleton instances. When hooks run concurrently (like `user-prompt-submit.ts` and `user-prompt-submit-thinking.ts`), they can both try to open and access the same database at the same time, causing mutex errors.

The solution is to:
1. Add a busy timeout to the SQLite database connection so it waits for locks to be released
2. Add retry logic around database operations that may fail due to temporary locks
3. Consider using WAL mode for better concurrency

Let me create a shared utility for opening the database with proper concurrency settings, and add retry logic. I'll create a wrapper that handles database connections with retry logic.

First, let me check if there's a utility file for database operations or if I should create one.

## Output

I can see the issue. Both `VectorStore` and `ThinkingVectorStore` use the same `memory.sqlite` file but open separate database connections. When hooks run concurrently, they conflict on the same database.

Let me create a shared database utility with proper concurrency handling:
