---
id: a58581dd-0c90-4ece-973d-2dca72e00017
subject: >-
  I see the issue! The singleton pattern ignores the baseDir if an instance
  already exists. This...
applies_to: global
occurred_at: '2025-12-01T20:32:28.043Z'
content_hash: 7834f3aebf29b1a2
---
I see the issue! The singleton pattern ignores the baseDir if an instance already exists. This causes test isolation issues - the singleton from one test leaks to another.But wait, the test creates new instances of MemoryManager with testDir, and the MemoryManager calls getVectorStore. But searchEngine also calls getVectorStore() without the baseDir.Let me look at the test more closely - in the test, they create a new searchEngine with `new SearchEngine(memoryManager)`, and SearchEngine calls `getVectorStore()` without any baseDir. So it would use the existing singleton which might point to a different directory.

Actually, looking at the issue again - the singleton is created with the first baseDir passed to it. If tests don't properly close and reset the singleton between tests, there could be data leakage.

But the test does call `vectorStore.close()` in afterEach. Let me check if close() resets the singleton.

Looking at close(), it just closes the db connection but doesn't reset the singleton instance. So subsequent calls to getVectorStore would return the same instance (with a closed db), but then initialize() would reopen it.

Actually, the bigger problem is that the tests create memories in testDir via MemoryManager, but the SearchEngine uses getVectorStore() without baseDir which might point to a different location.

Actually wait, looking at memory.ts - MemoryManager.createMemory calls getVectorStore with this.baseDir. So memories are added to the correct vectorStore.

But in the test, SearchEngine is created with just memoryManager, and SearchEngine calls getVectorStore() without baseDir. Let me check where SearchEngine gets its baseDir.

Actually, in search.ts line 33, it calls `getVectorStore()` with no parameters. So it relies on the singleton which may have been created with a different baseDir.

The fix should be to either:
1. Reset the singleton in test cleanup2. Have SearchEngine accept and use a baseDir


3. Have getVectorStore use config.memoryDir when no baseDir is passed

I'll implement a fallback mechanism for the vector store initialization. When no baseDir is explicitly provided, the function will default to using the configured memory directory. This ensures consistent behavior across different components and prevents potential data isolation issues in testing scenarios.
