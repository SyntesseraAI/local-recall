---
id: 59f35a5b-adb5-4370-b61a-25673d7e8bbc
subject: >-
  The hook runs the searches **sequentially** (first episodic with `await`, then
  thinking with...
applies_to: global
occurred_at: '2025-12-03T10:03:01.452Z'
content_hash: 232a3d533afc5698
---
## Thought

The hook runs the searches **sequentially** (first episodic with `await`, then thinking with `await`). So they shouldn't overlap in time from the client side. But the issue could be:

1. Multiple hook processes running concurrently (if Claude Code triggers multiple prompts quickly)
2. The daemon's HTTP handlers are async and could interleave operations

Wait, but the hook calls them sequentially, so within a single hook invocation, they won't overlap. However, if multiple prompts are submitted quickly, you could have multiple hook processes running, each making HTTP requests to the daemon.

But actually, looking at the error message again - it's coming from the hook process itself:
```
UserPromptSubmit says: Plugin hook error: libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument
```

Wait, that's interesting. The hook is crashing, not the daemon. But the hook uses DaemonClient which just makes HTTP requests - it shouldn't be loading sqlite-vec at all!

Let me check if there's any place in the hook or daemon client code that could be loading sqlite-vec directly.

Actually, looking at the imports in `daemon-client.ts`:
```javascript
import http from 'node:http';
import { getConfig } from './config.js';
import { logger } from './logger.js';
import type { Memory, SearchResult, ThinkingSearchResult, MemoryScope } from '../core/types.js';
```

And in `user-prompt-submit.ts`:
```javascript
import { loadConfig, getConfig } from "../utils/config.js";
import { DaemonClient } from "../utils/daemon-client.js";
import { formatMemoryForDisplay, formatThinkingMemoryForDisplay } from "../utils/markdown.js";
import { readStdin } from "../utils/transcript.js";
import { logger } from "../utils/logger.js";


```

I'll investigate the imports carefully to trace any potential sqlite-vec loading mechanism. The mutex error suggests a synchronization problem that might be related to unexpected library interactions.

## Output

The hook runs searches **sequentially**, not in parallel. But the error message says it's happening in the hook process. Let me check if the hook or its dependencies might be accidentally loading sqlite-vec somewhere.
