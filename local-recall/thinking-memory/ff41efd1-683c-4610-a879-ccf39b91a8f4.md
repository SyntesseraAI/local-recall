---
id: ff41efd1-683c-4610-a879-ccf39b91a8f4
subject: >-
  Now I understand the full flow: 1. The hook loads sqlite-vec via
  `openDatabase()` which calls...
applies_to: global
occurred_at: '2025-12-03T10:16:40.314Z'
content_hash: fee1e5bafe6eb349
---
## Thought

Now I understand the full flow:

1. The hook loads sqlite-vec via `openDatabase()` which calls `sqliteVec.load(db)` at line 152
2. The file locking mechanism (`withDbMutex`) is supposed to prevent concurrent access, but the mutex error is still happening

The issue is that sqlite-vec uses internal mutexes that can fail even with file locking if:
- Multiple processes load the sqlite-vec native library simultaneously
- The library's internal state gets corrupted

The logging currently is:
- At the hook level: just "UserPromptSubmit hook error:" with the error stringified
- At the database level: "Database opened successfully with sqlite-vec loaded"

To improve debugging, we should add:
1. More detailed logging around the sqlite-vec load point
2. Stack trace in the error catch
3. Timing information
4. Process/PID information to identify concurrent access
5. Lock acquisition details

Let me create a todo list and start improving the logging.

## Output

Now I understand the issue. The mutex error happens when `sqliteVec.load(db)` is called (database.ts:152). The file locking mechanism exists but the error still occurs. Let me add comprehensive logging to help debug this.
