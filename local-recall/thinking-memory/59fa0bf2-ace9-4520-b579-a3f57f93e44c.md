---
id: 59fa0bf2-ace9-4520-b579-a3f57f93e44c
subject: >-
  The mutex error is coming from sqlite-vec loading. The hook is using readonly
  mode but the error...
applies_to: global
occurred_at: '2025-12-03T09:15:13.898Z'
content_hash: bd6bbb5d51983999
---
## Thought

The mutex error is coming from sqlite-vec loading. The hook is using readonly mode but the error still occurs. Let me look at adding defensive error handling.Looking at the database utility, I need to wrap the extension loading to catch and handle errors. But since this is a C++ exception that terminates the process, I can't catch it directly.

However, I could try a different approach:
1. Wrap the entire database open in a try-catch
2. Use a file-based lock to prevent concurrent sqlite-vec loading

Actually, looking at sqlite-vec's behavior, it might help to ensure only one process loads it at a time. Let me add a simple file lock mechanism.But first, let me check if the issue is reproducible and if adding better error handling in the hook itself can help. The hook already catches errors and exits cleanly, but the C++ exception bypasses that.For now, let me update the hook to check if the database exists before trying to open it, and skip gracefully if it fails to load.

Actually, looking at this more carefully - the issue is that the `openDatabase` function calls `sqliteVec.load(db)` which is a native extension. If there's a race condition in the native code when multiple processes try to load it simultaneously, we get this mutex error.

One approach is to use a file lock (using fs.open with exclusive mode) before loading the database. Let me try adding this to the database.ts utility.

## Output

Let me add a file-based locking mechanism to prevent concurrent sqlite-vec loading issues:
