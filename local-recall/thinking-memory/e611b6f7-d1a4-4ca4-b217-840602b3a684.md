---
id: e611b6f7-d1a4-4ca4-b217-840602b3a684
subject: >-
  Looking at this transcript, I need to extract valuable memories that would
  help future AI...
applies_to: global
occurred_at: '2025-12-21T18:27:05.647Z'
content_hash: e9f45b2dd270a803
---
## Thought

Looking at this transcript, I need to extract valuable memories that would help future AI assistants working on this codebase.

Key learnings from the session:
1. **Root cause of mutex error**: The `mutex lock failed: Invalid argument` error in the UserPromptSubmit hook was caused by persistent singleton database connections that held onto sqlite-vec connections. When processes exit, Node.js garbage collects objects in unpredictable order, and sqlite-vec mutexes could be destroyed while cleanup code was still trying to use them.

2. **Solution implemented**: Refactored vector stores to use ephemeral connections instead of singletons. Each operation creates a fresh database connection, performs the operation, and closes immediately. This prevents connections from being held across operations.

3. **Bug found in SearchEngine**: When using the legacy constructor `SearchEngine(memoryManager)`, the SearchEngine wasn't passing the MemoryManager's baseDir to the vector store, causing it to use `config.memoryDir` instead. This broke when ephemeral connections were used.

4. **Architecture pattern**: The fix involved:
   - Removing singleton pattern from vector stores
   - Making database connections ephemeral (created and destroyed per operation)
   - Ensuring SearchEngine passes the correct baseDir to vector stores
   - Added getter to MemoryManager to expose baseDir

5. **Specific file details**:
   - `src/core/vector-store.ts` - Changed to ephemeral connections
   - `src/core/thinking-vector-store.ts` - Changed to ephemeral connections
   - `src/core/search.ts` - Updated to pass baseDir from MemoryManager
   - `src/core/thinking-search.ts` - Updated similarly

6. **Testing outcome**: All 289 tests pass after the changes

7. **Threading/mutex insight**: sqlite-vec uses internal mutexes that are sensitive to connection persistence and timing of object destruction. Ephemeral connections prevent the mutex contention that caused the error.


I'll structure these insights into a comprehensive JSON format that captures the core technical learnings and architectural improvements.

## Output

```json
{
  "memories": [
    {
      "subject": "sqlite-vec mutex error caused by persistent singleton connections",
      "keywords": ["mutex", "sqlite-vec", "singleton", "connection", "threading", "error", "cleanup"],
      "applies_to": "global",
      "content": "## Problem\n\nThe `mutex lock failed: Invalid argument` error in UserPromptSubmit hook was caused by:\n1. Vector stores used singleton pattern with persistent database connections\n2. sqlite-vec native extension uses internal mutexes\n3. When process exits, Node.js garbage collects objects in unpredictable order\n4. sqlite-vec mutexes could be destroyed while cleanup code still tries to use them\n\n## Solution\n\nRefactored vector stores to use **ephemeral connections** instead of singletons:\n- Each operation creates a fresh database connection\n- Performs operation (add/remove/search)\n- Closes connection immediately\n- Prevents connections from persisting across operations\n\nThis prevents the mutex contention and timing issues that caused the error."
    },
    {
      "subject": "SearchEngine must pass baseDir to vector stores",
      "keywords": ["searchengine", "vector-store", "basedir", "memorymanager", "path"],
      "applies_to": "file:src/core/search.ts",
      "content": "## Issue Found\n\nWhen using legacy constructor `SearchEngine(memoryManager)`, the SearchEngine wasn't passing the MemoryManager's baseDir to the vector store. This caused:\n- Vector store to use default `config.memoryDir` instead of MemoryManager's custom baseDir\n- Tests failed because episodic memory index couldn't be found\n- Problem was masked by singleton pattern (first call set baseDir for all subsequent calls)\n\n## Solution\n\nAdded a `getBaseDir()` getter to MemoryManager that exposes the baseDir path. Updated SearchEngine to:\n1. Store reference to MemoryManager\n2. Pass `memoryManager.getBaseDir()` when calling `getVectorStore()`\n3. Ensure vector store uses same directory as memory files\n\nApply same pattern to ThinkingSearchEngine."
    },
    {
      "subject": "Vector store refactoring removed singleton pattern for thread safety",
      "keywords": ["vector-store", "ephemeral", "connection", "singleton", "refactor"],
      "applies_to": "file:src/core/vector-store.ts",
      "content": "## Changes Made\n\nRefactored `src/core/vector-store.ts` from singleton pattern to ephemeral connections:\n- Removed static singleton instance and getInstance() pattern\n- Each method that uses database now creates fresh connection\n- Connection opened at start of operation, closed at end\n- No persistent connections held across operations\n\nSame refactoring applied to `src/core/thinking-vector-store.ts`.\n\n## Result\n\nAll 289 tests pass with this architecture change."
    },
    {
      "subject": "sqlite-vec requires careful connection lifecycle management",
      "keywords": ["sqlite-vec", "connection", "lifecycle", "threading", "mutex", "native"],
      "applies_to": "global",
      "content": "## Key Insight\n\nsqlite-vec is a native Node.js extension with internal mutexes. It's sensitive to:\n1. **Connection persistence**: Long-held connections can cause mutex contention\n2. **Garbage collection timing**: Object destruction order matters for proper cleanup\n3. **Ephemeral connections**: Creating/destroying connections per operation is safer\n\n## Best Practice\n\nFor sqlite-vec usage in this codebase:\n- Avoid singleton patterns that hold persistent connections\n- Create connections only for atomic operations\n- Close connections immediately after use\n- This prevents mutex deadlocks during process shutdown"
    }
  ]
}
```
