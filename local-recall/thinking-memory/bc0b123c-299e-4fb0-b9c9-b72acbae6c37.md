---
id: bc0b123c-299e-4fb0-b9c9-b72acbae6c37
subject: >-
  The user is showing me logs that indicate a problem with the "session
  guarding" - it looks like the...
applies_to: global
occurred_at: '2025-11-30T14:56:45.607Z'
content_hash: cf435311c2861fef
---
The user is showing me logs that indicate a problem with the "session guarding" - it looks like the UserPromptSubmit hook is not properly filtering out internal prompts that are being sent to Claude for memory extraction or keyword extraction.

Looking at the logs:
1. At 14:55:01.205Z - There's a prompt with "[LOCAL_RECALL_INTERNAL]" prefix that IS being correctly skipped: "Skipping internal Local Recall prompt to prevent recursion"
2. At 14:55:31.997Z - There's another prompt that looks like an internal memory extraction prompt (starts with "You are analyzing a Claude Code session transcript...") but it's NOT being skipped

The issue is that the second prompt doesn't have the "[LOCAL_RECALL_INTERNAL]" prefix, so it's not being caught by the guard.

Let me look at the user-prompt-submit.ts hook to understand how the guarding works and see what needs to be fixed.
