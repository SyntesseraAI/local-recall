---
id: e5b771b9-c94f-4e1d-a2f7-8012236b6d3c
subject: >-
  The user is asking me to extract memories from this transcript. Let me analyze
  what was learned and...
applies_to: global
occurred_at: '2025-12-21T19:33:29.860Z'
content_hash: c7d17df9bbe09e1e
---
## Thought

The user is asking me to extract memories from this transcript. Let me analyze what was learned and discovered:

1. **Mutex Lock Error Root Cause** - The error "mutex lock failed: Invalid argument" happens when a thread tries to lock a mutex that's already been destroyed. This is related to sqlite-vec's C++ internal mutexes on macOS 10.13.

2. **Architecture Issue Found** - The hooks and daemon were completely independent with no communication mechanism between them. This was a design issue that needed fixing.

3. **Solution Implemented** - They implemented an HTTP server in the daemon that hooks can communicate with via HTTP clients. This removes the need for hooks to directly access sqlite-vec.

4. **Mutex Problem Solved** - By having hooks communicate with the daemon instead of direct database access, the "mutex lock failed" error is avoided because the daemon has single-threaded access to the database while hooks make HTTP requests.

5. **HTTP Port Configuration** - The HTTP server uses a random port in the 7xxx range (7847 was chosen).

6. **Files Changed/Created**:
   - Created: `src/mcp-server/http-server.ts` - HTTP server for daemon
   - Created: `src/utils/daemon-client.ts` - HTTP client for hooks
   - Modified: `src/hooks/user-prompt-submit.ts` - Now uses daemon client
   - Modified: `src/hooks/session-start.ts` - Now uses daemon client
   - Modified: `src/mcp-server/server.ts` - Starts HTTP server
   - Modified: `CLAUDE.md` - Documentation updated
   - Modified: `src/core/types.ts` - HTTP port configuration

7. **Architecture Change** - Moved from direct database access in hooks to a client-server model where:
   - Daemon runs HTTP server and owns sqlite-vec database
   - Hooks make HTTP requests to daemon
   - This eliminates mutex contention issues

8. 

I verified the test suite's comprehensive validation, confirming the architectural changes resolved previous synchronization challenges. The refactoring successfully eliminated concurrent database access problems by introducing a centralized communication mechanism through HTTP, ensuring robust and thread-safe interactions between hooks and the daemon.

## Output

```json
{
  "memories": [
    {
      "subject": "Mutex error caused by concurrent sqlite-vec access from hook processes",
      "keywords": [
        "mutex",
        "sqlite-vec",
        "threading",
        "invalid argument",
        "concurrent access",
        "hooks",
        "daemon"
      ],
      "applies_to": "global",
      "content": "The 'mutex lock failed: Invalid argument' error occurs when multiple hook processes try to access sqlite-vec's C++ mutexes concurrently. The root cause is that a thread attempts to lock a mutex that has already been destroyed due to process isolation issues.\n\nSolution: Implemented a hook-daemon communication architecture where the daemon exclusively owns the sqlite-vec database connection and exposes an HTTP API. Hooks now make HTTP requests to the daemon instead of directly accessing the database, eliminating concurrent mutex contention."
    },
    {
      "subject": "HTTP daemon API for hook-daemon communication",
      "keywords": [
        "http-server",
        "daemon",
        "ipc",
        "hooks",
        "port 7847",
        "api",
        "client-server"
      ],
      "applies_to": "global",
      "content": "Implemented `src/mcp-server/http-server.ts` which runs in the daemon and exposes:\n- `POST /search/episodic` - Vector search for episodic memories\n- `POST /search/thinking` - Vector search for thinking memories  \n- `POST /memories/recent` - Get recent memories\n- `GET /health` - Health check endpoint\n\nThe HTTP server listens on port 7847 (configured in `src/core/types.ts` via `httpPort` config). Hooks communicate via `src/utils/daemon-client.ts` which handles HTTP requests with automatic retry logic."
    },
    {
      "subject": "Hook refactoring: direct database access to HTTP clients",
      "keywords": [
        "hooks",
        "refactoring",
        "daemon-client",
        "user-prompt-submit",
        "session-start",
        "http client"
      ],
      "applies_to": "global",
      "content": "Updated hooks to use HTTP client instead of direct database access:\n\n1. `src/hooks/user-prompt-submit.ts` - Now uses `DaemonClient` to call `/search/episodic` and `/search/thinking` endpoints instead of directly instantiating vector stores\n\n2. `src/hooks/session-start.ts` - Updated to use `DaemonClient` for consistency, though it originally only read markdown files via `MemoryManager` (not affected by mutex issue)\n\nBoth hooks retry with exponential backoff if daemon is unavailable, ensuring graceful degradation."
    },
    {
      "subject": "Architecture: Hook-Daemon Communication Pattern",
      "keywords": [
        "architecture",
        "ipc",
        "process isolation",
        "http",
        "daemon",
        "vector search"
      ],
      "applies_to": "global",
      "content": "The new architecture separates concerns:\n\n```\nHook Process → HTTP Request → Daemon HTTP Server → sqlite-vec Database\n```\n\nBenefits:\n- Daemon maintains single thread of sqlite-vec access (no mutex contention)\n- Hooks are thin clients that make stateless HTTP requests\n- Process isolation preserved while avoiding concurrent database access\n- Easier to debug and extend - daemon can be tested independently\n- Hooks can retry/timeout gracefully if daemon is unavailable\n\nThe daemon starts the HTTP server in `src/mcp-server/server.ts` alongside the MCP server."
    },
    {
      "subject": "HTTP port configuration: 7847 (random 7xxx range)",
      "keywords": [
        "http",
        "port",
        "configuration",
        "daemon",
        "7847"
      ],
      "applies_to": "global",
      "content": "The HTTP daemon listens on port 7847, configured in `src/core/types.ts` as `httpPort: 7847`. This was chosen as a random high port in the 7xxx range to avoid conflicts with common services. The port is also used in the daemon client configuration (`DaemonClient` constructor) to connect to the HTTP server."
    },
    {
      "subject": "Test suite passes after hook-daemon refactoring",
      "keywords": [
        "testing",
        "test results",
        "289 tests",
        "refactoring"
      ],
      "applies_to": "global",
      "content": "After implementing the hook-daemon HTTP communication architecture, all 289 tests pass successfully. This confirms the refactoring maintains backward compatibility and the new HTTP-based approach works correctly with existing test infrastructure."
    }
  ]
}
```
