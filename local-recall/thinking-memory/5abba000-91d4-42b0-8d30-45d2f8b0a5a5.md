---
id: 5abba000-91d4-42b0-8d30-45d2f8b0a5a5
subject: Let me provide a summary of the fixes I made.
applies_to: global
occurred_at: '2025-12-03T09:18:41.181Z'
content_hash: 3f61e24d3d063d31
---
## Thought

Let me provide a summary of the fixes I made.

## Output

Both issues have been fixed:

## Summary

### Fix 1: Thinking Extractor (src/core/thinking-extractor.ts:89-159)

**Problem**: The extractor expected thinking and text content to be in the same JSONL line, but Claude Code streams each content block as separate lines with the same `message.id`.

**Solution**: Modified `parseTranscriptForThinking` to:
1. Parse all JSONL lines
2. Group entries by `message.id` using a Map
3. Aggregate thinking and text content from entries with the same message ID
4. Create a thinking memory when both thinking AND text exist for a message

**Result**: 616 thinking memories created from 59 transcripts (vs 0 before).

### Fix 2: Mutex Lock Error (src/utils/database.ts:49-104)

**Problem**: Multiple processes loading `sqlite-vec` simultaneously caused a C++ mutex error that terminated the process.

**Solution**: Added a file-based lock mechanism (`acquireLock`) that:
1. Uses `O_EXCL` flag to create an exclusive lock file (`.sqlite-vec.lock`)
2. Waits with retry (up to 5 seconds) if another process holds the lock
3. Detects and removes stale locks (older than 30 seconds)
4. Releases lock after `sqlite-vec.load(db)` completes

This ensures only one process loads the sqlite-vec extension at a time, preventing the mutex race condition.
