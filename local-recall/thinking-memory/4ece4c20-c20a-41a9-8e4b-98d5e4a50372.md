---
id: 4ece4c20-c20a-41a9-8e4b-98d5e4a50372
subject: >-
  The MCP server doesn't have an HTTP server component. Looking at the CLAUDE.md
  description vs the...
applies_to: global
occurred_at: '2025-12-03T11:21:20.708Z'
content_hash: dbc83d07374294c1
---
## Thought

The MCP server doesn't have an HTTP server component. Looking at the CLAUDE.md description vs the actual code:

1. **CLAUDE.md describes**: HTTP endpoints on port 7847 (`/search/episodic`, `/search/thinking`, etc.) and a `DaemonClient` for hooks to call
2. **Actual code**: No HTTP server, no DaemonClient - the hooks directly load the embedding service

The HTTP daemon architecture described in CLAUDE.md hasn't been implemented yet. The current situation is:
- The MCP server runs as a single process and owns the vector stores
- But the hooks (user-prompt-submit) directly instantiate `SearchEngine` and `ThinkingSearchEngine`, which load the embedding model
- When multiple hook processes run concurrently, they all try to load the ONNX runtime, causing mutex errors

The fix would be to:
1. Add an HTTP server to the MCP daemon (port 7847)
2. Create a `DaemonClient` class for hooks to use
3. Update `user-prompt-submit.ts` to use the daemon client instead of direct search

This is a significant change. Let me summarize what I found for the user.

## Output

**Summary of findings:**

The mutex errors are from **ONNX runtime** (fastembed embedding model), not sqlite-vec. The Orama migration fixed the SQLite issues, but the ONNX runtime still has mutex problems when multiple processes load it concurrently.

**Root cause:** `user-prompt-submit.ts` directly instantiates `SearchEngine`/`ThinkingSearchEngine`, which load the embedding model. The `proper-lockfile` doesn't prevent ONNX's internal mutex issues.

**What's described in CLAUDE.md vs reality:**
| Component | CLAUDE.md | Actual |
|-----------|-----------|--------|
| HTTP Server (port 7847) | Described | Not implemented |
| DaemonClient | Described | Not implemented |
| Hooks use HTTP | Yes | No - direct embedding |

**The fix** would be implementing the HTTP daemon architecture:
1. Add HTTP server to MCP daemon exposing `/search/episodic`, `/search/thinking`
2. Create `DaemonClient` for hooks
3. Update `user-prompt-submit.ts` to use HTTP calls instead of direct search

Want me to implement this?
