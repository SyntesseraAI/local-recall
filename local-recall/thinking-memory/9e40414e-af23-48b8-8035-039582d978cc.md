---
id: 9e40414e-af23-48b8-8035-039582d978cc
subject: >-
  The user is asking me to extract memories from a transcript of a Claude Code
  session. The...
applies_to: global
occurred_at: '2025-12-21T19:21:59.086Z'
content_hash: 9f056531161ac00a
---
## Thought

The user is asking me to extract memories from a transcript of a Claude Code session. The transcript shows that I (as an assistant) was helping debug and fix a mutex lock error in the local-recall project.

Key findings from the transcript:
1. The error was: "libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument"
2. Root cause: Singleton pattern with persistent database connections from sqlite-vec
3. Solution: Changed to ephemeral connections that are only created for atomic operations
4. Modified files:
   - src/core/vector-store.ts
   - src/core/thinking-vector-store.ts
   - src/core/search.ts
   - src/core/memory.ts
   - src/core/thinking-search.ts
   - src/core/thinking-memory.ts (likely)

5. Also fixed: The SearchEngine was using wrong baseDir because it wasn't passing it when calling getVectorStore()

6. Tests: All 289 tests pass after the fixes

Let me extract the valuable memories:

1. Mutex lock failed error root cause and solution
2. The singleton pattern issue with sqlite-vec
3. The baseDir issue in SearchEngine
4. Connection lifecycle management pattern
5. The architectural decision to use ephemeral connections

Let me structure these as memories:

Memory 1: The mutex lock error and its root cause
- Keywords: mutex lock failed, sqlite-vec, singleton, garbage collection, connection lifecycle
- Applies to: global (architectural decision)
- Content: Explanation of the error and why it happens

Memory 2: Solution - ephemeral connections
- Keywords: ephemeral connections, atomic operations, connection pooling, sqlite-vec
- Applies to: area:vector-store
- Content: How the solution works

Memory 3: The baseDir configuration issue
- Keywords: baseDir, SearchEngine, MemoryManager, configuration passing


- Applies to: file:src/core/search.ts, file:src/core/thinking-search.ts
- Content: How SearchEngine needs to receive baseDir from MemoryManager

I'll focus on the SearchEngine's baseDir configuration. The core issue involves ensuring the correct base directory is passed through the system. SearchEngine requires baseDir from MemoryManager to correctly initialize vector stores. This means modifying how configuration parameters are propagated between different components of the system.

The fix involves updating method signatures and call chains to explicitly pass the baseDir, preventing misconfigurations that could lead to incorrect file paths or connection issues.

## Output

```json
{
  "memories": [
    {
      "subject": "Mutex lock error caused by persistent sqlite-vec connections and garbage collection order",
      "keywords": ["mutex lock failed", "sqlite-vec", "singleton pattern", "garbage collection", "connection lifecycle", "native extension"],
      "applies_to": "global",
      "content": "## Problem\n\nThe UserPromptSubmit hook was crashing with: `libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument`\n\n## Root Cause\n\n1. Vector store used a singleton pattern with persistent database connections throughout the process lifetime\n2. The sqlite-vec native extension uses internal mutexes for thread safety\n3. When the Node.js process exits, objects are garbage collected in an unpredictable order\n4. If sqlite-vec mutexes were destroyed while cleanup code was still trying to use them, the error occurred\n\n## Key Insight\n\nThe error was non-deterministic and only appeared sometimes because it depended on the garbage collection order. The singleton pattern masked the underlying issue by keeping connections alive for the entire process.\n\n## Why This Matters\n\nWith hooks that run for brief periods (like UserPromptSubmit), persistent connections that outlive their usefulness create unnecessary resource pressure and timing dependencies."
    },
    {
      "subject": "Fix: Use ephemeral connections for vector store operations instead of persistent singletons",
      "keywords": ["ephemeral connections", "atomic operations", "connection pooling", "vector-store", "thinking-vector-store", "lifecycle management"],
      "applies_to": "area:vector-store",
      "content": "## Solution Pattern\n\nChanged from singleton pattern with persistent connections to ephemeral connections created for each atomic operation:\n\n```typescript\n// Old (problematic):\nconst store = getVectorStore(); // singleton, lives forever\nawait store.search(query);\n\n// New (correct):\nconst store = getVectorStore({ readonly: true }); // fresh instance\ntry {\n  await store.search(query);\n} finally {\n  await store.close(); // cleanup happens immediately\n}\n```\n\n## Benefits\n\n1. **No dangling connections** - Resources are freed as soon as the operation completes\n2. **Predictable cleanup** - Mutexes are destroyed in the correct order\n3. **Reduced memory pressure** - Each hook invocation doesn't accumulate resources\n4. **Thread safety** - No race conditions from concurrent hook executions\n\n## Files Modified\n\n- `src/core/vector-store.ts` - Added connection lifecycle management\n- `src/core/thinking-vector-store.ts` - Applied same pattern\n- `src/core/search.ts` - Updated to use ephemeral connections\n- `src/core/thinking-search.ts` - Updated to use ephemeral connections\n\n## Important Note\n\nThe hooks (session-start, user-prompt-submit, user-prompt-submit-thinking) now properly clean up connections when they exit, preventing the mutex error."
    },
    {
      "subject": "SearchEngine was using wrong baseDir due to missing parameter passing from MemoryManager",
      "keywords": ["SearchEngine", "baseDir", "configuration", "MemoryManager", "parameter passing"],
      "applies_to": "file:src/core/search.ts",
      "content": "## Issue\n\nWhen SearchEngine called `getVectorStore({ readonly: true })`, it wasn't passing the `baseDir` parameter. This caused it to use the global config's `memoryDir` instead of the MemoryManager's `baseDir`.\n\n## Why The Singleton Masked This\n\nThe old singleton pattern meant that the first call to `getVectorStore()` would set the baseDir, and all subsequent calls returned the same instance. This hid the configuration mismatch.\n\n## Solution\n\n1. Added a `getBaseDir()` getter to MemoryManager to expose the directory\n2. Updated SearchEngine to accept baseDir in its options or retrieve it from the MemoryManager\n3. Pass baseDir when calling `getVectorStore({ baseDir, readonly: true })`\n\n## Applied To\n\n- `src/core/search.ts` - SearchEngine now passes baseDir\n- `src/core/thinking-search.ts` - ThinkingSearchEngine now passes baseDir\n- `src/core/memory.ts` - Added getBaseDir() getter\n- `src/core/thinking-memory.ts` - Added getBaseDir() getter (inferred from pattern)\n\n## Test Verification\n\nAll 289 tests pass after these changes, confirming the fix resolves integration test failures."
    },
    {
      "subject": "Connection lifecycle must be carefully managed in hooks to avoid mutex lock errors",
      "keywords": ["hooks", "connection cleanup", "resource management", "finally blocks", "garbage collection", "process lifecycle"],
      "applies_to": "area:hooks",
      "content": "## Pattern for Hook Implementation\n\nSince hooks execute in short-lived processes, connection management is critical:\n\n```typescript\nconst store = getVectorStore({ readonly: true });\ntry {\n  // Do work\n  const results = await store.search(query);\n  return results;\n} finally {\n  // ALWAYS cleanup, even on error\n  await store.close();\n}\n```\n\n## Why This Matters for Hooks\n\n1. Hook processes are spawned by Claude Code and exit after one invocation\n2. If connections persist until process exit, garbage collection timing becomes critical\n3. sqlite-vec mutexes may be destroyed before cleanup code runs\n4. Explicit cleanup ensures predictable resource destruction\n\n## Common Hook Types\n\n- `SessionStart` - Loads recent memories\n- `UserPromptSubmit` - Searches episodic and thinking memories\n- `UserPromptSubmit-Thinking` - Searches thinking memories only\n\nAll hooks in this project now follow the ephemeral connection pattern."
    }
  ]
}
```
