---
id: 7e009e7d-17a4-4fb8-8703-62b9c358ae14
subject: >-
  The error is on line 211 in the `stripMarkdownCodeBlocks` method:
  ```typescript private...
applies_to: global
occurred_at: '2025-11-30T20:51:01.708Z'
content_hash: 9242505e5233a362
---
## Thought

The error is on line 211 in the `stripMarkdownCodeBlocks` method:

```typescript
private stripMarkdownCodeBlocks(text: string): string {
  // Match ```json ... ``` or ``` ... ```
  const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
  if (codeBlockMatch) {
    return codeBlockMatch[1].trim();
  }
  return text.trim();
}
```

The issue is that TypeScript is correctly identifying that even though we check `if (codeBlockMatch)`, the capture group `codeBlockMatch[1]` could still be undefined (if the regex matched but the capture group didn't capture anything).

The fix is to add a null check for `codeBlockMatch[1]` as well. We can do this by checking `codeBlockMatch[1]` exists before calling `.trim()` on it.

A simple fix:
```typescript
if (codeBlockMatch && codeBlockMatch[1]) {
  return codeBlockMatch[1].trim();
}
```

Or using optional chaining with nullish coalescing:
```typescript
if (codeBlockMatch?.[1]) {
  return codeBlockMatch[1].trim();
}
```

Let me fix this.

## Output

The error is on line 211 where TypeScript correctly identifies that `codeBlockMatch[1]` could be undefined even when `codeBlockMatch` is truthy (if the capture group didn't match). I'll add a check for the capture group.
