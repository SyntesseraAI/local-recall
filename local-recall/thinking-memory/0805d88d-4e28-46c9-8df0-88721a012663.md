---
id: 0805d88d-4e28-46c9-8df0-88721a012663
subject: >-
  Now I can see the issue. Both vector stores: 1. Use the same database file
  (`memory.sqlite`) 2....
applies_to: global
occurred_at: '2025-12-03T10:02:14.242Z'
content_hash: a6e22ea11749009c
---
## Thought

Now I can see the issue. Both vector stores:
1. Use the same database file (`memory.sqlite`)
2. Both call `openDatabase()` from `../utils/database.js`

The problem is that when `handleEpisodicSearch` and `handleThinkingSearch` are called concurrently (or in quick succession), they each:
1. Initialize their embedding service
2. Open a database connection
3. Run their query
4. Close the connection

The issue is likely in the embedding service initialization or the database opening. If both are running concurrently:
- Each calls `this.embeddingService.initialize()` 
- Each calls `this.openConnection()` which loads sqlite-vec

Even though they use ephemeral connections, if both are trying to initialize at the same time, they could be creating multiple sqlite-vec instances in the same process which causes mutex issues.

Let me check the embedding service and database utility to see if they handle concurrent access properly.

## Output

I see they both use the same database file but open separate connections. Let me check the `database.js` utility and the embedding service to see how they handle concurrent access.
