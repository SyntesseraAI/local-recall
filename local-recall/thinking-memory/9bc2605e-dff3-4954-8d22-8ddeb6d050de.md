---
id: 9bc2605e-dff3-4954-8d22-8ddeb6d050de
subject: >-
  Let me analyze this transcript to extract valuable memories. The session
  involved: 1. **Problem**:...
applies_to: global
occurred_at: '2025-12-03T10:01:34.147Z'
content_hash: 701711c441771288
---
## Thought

Let me analyze this transcript to extract valuable memories. The session involved:

1. **Problem**: A "mutex lock failed: Invalid argument" error from sqlite-vec
2. **Root Cause**: The error occurs when threads try to load sqlite-vec concurrently, which causes mutex issues
3. **Solution**: Implemented a hook-daemon architecture where:
   - The MCP daemon runs as a single process that owns sqlite-vec
   - Hooks communicate with the daemon via HTTP to avoid concurrent sqlite-vec loads
   - HTTP server exposes endpoints for searching episodic and thinking memories

Key memories to extract:

1. **Mutex error root cause and solution** - This is specific to this codebase and important for future work
2. **Hook-daemon communication pattern** - The architectural pattern implemented
3. **HTTP port choice** - Changed to 7847 (random in 7xxx range)
4. **HTTP endpoints exposed** - The specific endpoints the daemon exposes
5. **Session-start hook is safe** - It doesn't use sqlite-vec directly
6. **Why concurrent sqlite-vec loading fails** - Understanding the threading issue

Let me structure these as memories:

1. The mutex error happens because sqlite-vec uses internal C++ mutexes that get destroyed when multiple processes try to load it
2. The solution is a hook-daemon architecture where hooks are thin HTTP clients and the daemon is the only process that loads sqlite-vec
3. The HTTP server runs on port 7847 (configurable via HTTP_PORT in types.ts)
4. Three main HTTP endpoints: /search/episodic, /search/thinking, /memories/recent, plus /health for health check
5. Session-start hook doesn't need the daemon because it only reads markdown files (no sqlite-vec)
6. User-prompt-submit hook needed to be updated to use daemon client
7. Stop hook interaction (though it was mentioned as disabled in the CLAUDE.md context)

Let me extract these properly:

## Output

```json
{
  "memories": [
    {
      "subject": "Mutex lock failed error caused by concurrent sqlite-vec loading across processes",
      "keywords": ["sqlite-vec", "mutex", "concurrency", "threading", "error", "pthread", "EINVAL"],
      "applies_to": "global",
      "content": "The 'mutex lock failed: Invalid argument' error occurs when multiple processes try to load sqlite-vec simultaneously. The error is a C++ pthread_mutex_lock() returning EINVAL, which happens when a thread attempts to lock a mutex that has already been destroyed. This occurs because sqlite-vec uses internal C++ mutexes for thread safety, and concurrent process initialization causes mutex destruction race conditions.\n\n**Solution**: Implement a hook-daemon architecture where only the MCP daemon process loads sqlite-vec, and hooks communicate with the daemon via HTTP to avoid concurrent loading."
    },
    {
      "subject": "Hook-daemon HTTP communication architecture implemented to fix sqlite-vec concurrency issue",
      "keywords": ["hooks", "daemon", "http", "architecture", "ipc", "thin-client"],
      "applies_to": "global",
      "content": "Implemented a hook-daemon communication pattern:\n\n```\n┌─────────────────────┐     HTTP     ┌─────────────────────┐\n│   Hook Process      │◄────────────►│   MCP Daemon        │\n│   (thin client)     │   localhost  │   (owns sqlite-vec) │\n├─────────────────────┤    :7847     ├─────────────────────┤\n│ • DaemonClient      │              │ • HTTP Server       │\n│ • No sqlite-vec     │              │ • Vector Store      │\n│ • Fallback to files │              │ • Search Engines    │\n└─────────────────────┘              └─────────┬───────────┘\n                                               │\n                                       ┌───────▼───────┐\n                                       │ memory.sqlite │\n                                       └───────────────┘\n```\n\nHooks become thin HTTP clients (DaemonClient in src/utils/daemon-client.ts) that communicate with the daemon. The daemon is the single process that owns sqlite-vec and the vector store. This prevents mutex contention and allows safe concurrent hook execution."
    },
    {
      "subject": "HTTP server port configured to 7847 for daemon-hook communication",
      "keywords": ["http", "port", "7847", "daemon", "configuration", "http-server"],
      "applies_to": "file:src/mcp-server/http-server.ts",
      "content": "The HTTP server listening port is configured via the `HTTP_PORT` environment variable in src/core/types.ts, with a default of 7847. This port was chosen as a random port in the 7xxx range to minimize conflicts with other services. The daemon HTTP server exposes the following endpoints:\n\n- `POST /search/episodic` - Vector search for episodic memories\n- `POST /search/thinking` - Vector search for thinking memories  \n- `POST /memories/recent` - Get recent memories\n- `GET /health` - Health check endpoint\n\nHooks check the health endpoint first to determine if the daemon is available before making requests."
    },
    {
      "subject": "Session-start hook doesn't need daemon because it only reads markdown files",
      "keywords": ["session-start", "hook", "daemon", "optional", "fallback", "markdown"],
      "applies_to": "file:src/hooks/session-start.ts",
      "content": "The session-start hook can operate safely without the daemon because it only needs to list recent memories by reading markdown files (MemoryManager). It doesn't use sqlite-vec at all. The updated hook still checks for daemon availability for consistency, but gracefully falls back to direct file reading if the daemon isn't available. This makes session-start robust and doesn't require the daemon to be running."
    },
    {
      "subject": "User-prompt-submit hook updated to use daemon HTTP client for memory searches",
      "keywords": ["user-prompt-submit", "hook", "daemon-client", "http", "search"],
      "applies_to": "file:src/hooks/user-prompt-submit.ts",
      "content": "The user-prompt-submit hook was refactored to use the DaemonClient to communicate with the daemon via HTTP instead of directly accessing sqlite-vec. The hook:\n\n1. Checks daemon health via `GET /health`\n2. If daemon unavailable: exits gracefully (no search performed)\n3. If daemon available and episodicEnabled: calls `POST /search/episodic` with the user prompt\n4. If daemon available and thinkingEnabled: calls `POST /search/thinking` with the user prompt\n5. Combines results from both searches and outputs to stdout\n\nConfiguration options for episodic and thinking searches (max tokens, min similarity) are sent in the HTTP request body."
    },
    {
      "subject": "HTTP server module created to handle all daemon HTTP endpoints",
      "keywords": ["http-server", "server.ts", "mcp-server", "express", "endpoints", "search"],
      "applies_to": "file:src/mcp-server/http-server.ts",
      "content": "New file src/mcp-server/http-server.ts implements the HTTP server that runs in the MCP daemon process. It exports:\n\n- `startHttpServer(port)` - Starts the HTTP server on specified port\n- Handlers for /search/episodic, /search/thinking, /memories/recent, /health endpoints\n- Error handling and CORS support\n- Request validation for search parameters\n\nThe HTTP server is started by the main MCP server (server.ts) which imports and calls startHttpServer() during initialization."
    },
    {
      "subject": "DaemonClient utility module created for hook HTTP communication",
      "keywords": ["daemon-client", "http-client", "hooks", "utilities", "fetch", "communication"],
      "applies_to": "file:src/utils/daemon-client.ts",
      "content": "New file src/utils/daemon-client.ts exports utility functions for hooks to communicate with the daemon:\n\n- `checkDaemonHealth(port)` - Checks if daemon is available via /health endpoint\n- `searchEpisodic(port, query, options)` - Calls POST /search/episodic\n- `searchThinking(port, query, options)` - Calls POST /search/thinking\n- `getRecentMemories(port, limit)` - Calls POST /memories/recent\n\nAll functions include timeout handling (30 seconds default) and graceful error handling. They use native fetch API and return structured results.\n\nConfiguration supports custom port and hostname via environment variables (HTTP_HOST, HTTP_PORT)."
    }
  ]
}
```
