---
id: f65fdb40-e472-4e02-b340-90de1e69ccd0
subject: Let me also save a memory about this fix for future reference.
applies_to: global
occurred_at: '2025-12-03T09:36:30.037Z'
content_hash: b54b6f0ba9e3d8b0
---
## Thought

Let me also save a memory about this fix for future reference.

## Output

## Summary

The `mutex lock failed: Invalid argument` error was caused by **persistent singleton database connections** combined with **sqlite-vec's internal mutexes**. When the process exits, Node.js garbage collects objects in an unpredictable order, and the sqlite-vec mutexes could be destroyed while cleanup code was still trying to use them.

### Key Changes Made:

1. **`src/core/vector-store.ts`**: Refactored to use **ephemeral connections**
   - Each operation (`add`, `remove`, `search`, `getStoredIds`) now opens a fresh database connection and closes it in a `finally` block
   - Removed the singleton pattern - `getVectorStore()` now creates a new instance each time
   - The `close()` method is now a no-op since connections are cleaned up per-operation

2. **`src/core/thinking-vector-store.ts`**: Same ephemeral connection pattern applied

3. **`src/core/search.ts`**: Added `baseDir` tracking
   - Now properly passes `baseDir` to `getVectorStore()` to ensure consistency with the MemoryManager
   - Uses the MemoryManager's `baseDir` when using the legacy constructor

4. **`src/core/thinking-search.ts`**: Same `baseDir` tracking applied

5. **`src/core/memory.ts`**: Added public `baseDir` getter so SearchEngine can access it

### Why This Works:

From the [Stack Overflow research](https://stackoverflow.com/questions/30090108/what-does-mutex-lock-fail-with-invalid-argument-mean): *"This typically happens when .lock() is called on a mutex that has already been destructed."*

By opening and closing connections for each atomic operation, there's no persistent connection state that can be destroyed in the wrong order during process exit. Each operation is self-contained:
1. Open connection
2. Do work
3. Close connection in `finally` block

All 289 tests pass.
