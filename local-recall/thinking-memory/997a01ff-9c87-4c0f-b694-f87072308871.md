---
id: 997a01ff-9c87-4c0f-b694-f87072308871
subject: >-
  15 mutex errors from 15 processes (3 runs × 5 processes). The file locking
  isn't working. The issue...
applies_to: global
occurred_at: '2025-12-03T11:20:51.936Z'
content_hash: 87cfe86dc8d05340
---
## Thought

15 mutex errors from 15 processes (3 runs × 5 processes). The file locking isn't working. The issue is that the ONNX runtime mutex errors happen even with proper-lockfile because:

1. The file lock protects the initialization function
2. But multiple processes can still be trying to load the onnxruntime library simultaneously
3. The ONNX runtime itself has internal mutexes that fail

The fix mentioned in the CLAUDE.md was to use the HTTP daemon architecture - hooks should call the daemon via HTTP instead of loading the embedding model directly. The daemon owns the ONNX runtime and all embedding calls go through it.

Let me check if the session-start hook uses the daemon approach, and compare it to the user-prompt-submit hook.

## Output

Confirmed - 15 mutex errors from 15 concurrent processes. The `proper-lockfile` isn't preventing ONNX runtime's internal mutex issues.

The fix described in CLAUDE.md is to use the **HTTP daemon architecture** - hooks should call the MCP daemon via HTTP instead of loading embeddings directly. Let me check if session-start uses this approach:
