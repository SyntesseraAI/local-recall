---
id: 335781b8-b190-4f52-b9bb-56f1e3d59f6f
subject: >-
  Now I can see the issue. The user-prompt-submit hook is directly instantiating
  `SearchEngine` and...
applies_to: global
occurred_at: '2025-12-03T10:31:49.838Z'
content_hash: 254ad7c705c40c39
---
## Thought

Now I can see the issue. The user-prompt-submit hook is directly instantiating `SearchEngine` and `ThinkingSearchEngine` which likely load sqlite-vec directly. According to the CLAUDE.md documentation, the architecture was designed to have hooks communicate with the MCP daemon via HTTP to avoid this exact problem.

Let me check the SearchEngine and ThinkingSearchEngine to confirm they use sqlite-vec directly, and also check if there used to be a daemon-client that would communicate via HTTP instead.

Looking at the git status, I can see:
- `D src/utils/daemon-client.ts` - This file was deleted
- `D src/mcp-server/http-server.ts` - This file was deleted

The documentation mentions:
- HTTP endpoints exposed by daemon on localhost:7847
- DaemonClient for hooks to use
- HTTP Server in the MCP daemon

So it looks like the HTTP-based architecture was removed and the hooks now load sqlite-vec directly, which is causing the mutex errors.

Let me check the vector-store and thinking-vector-store to understand how they handle sqlite-vec, and also check if there's some kind of locking mechanism.

## Output

I see the issue. The hooks are directly instantiating `SearchEngine` and `ThinkingSearchEngine` which load sqlite-vec. According to the CLAUDE.md, there was supposed to be an HTTP daemon architecture to avoid this, but I see in the git status that `daemon-client.ts` and `http-server.ts` were deleted.

Let me check the vector store implementation and understand what happened:
